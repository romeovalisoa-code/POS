<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SHOP MIHARISOA - Système de Gestion de Point de Vente</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2c3e50;
      --primary-light: #3498db;
      --danger: #e74c3c;
      --warning: #f39c12;
      --success: #27ae60;
      --info: #17a2b8;
      --bg: #f5f6fa;
      --card-bg: #ffffff;
      --border: #dcdde1;
      --text: #2d3436;
      --text-light: #636e72;
      --shadow: rgba(0, 0, 0, 0.1);
      --sidebar-width: 260px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* === LAYOUT PRINCIPAL === */
    .app-container {
      display: flex;
      min-height: 100vh;
    }

    /* === SIDEBAR === */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--primary);
      color: white;
      padding: 20px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      transition: transform 0.3s ease;
      z-index: 1000;
    }

    .sidebar-header {
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
    }

    .sidebar-header h2 {
      font-size: 1.4rem;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .company-name {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px 20px;
      background: rgba(0, 0, 0, 0.2);
      margin: 10px 20px;
      border-radius: 8px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .user-details {
      flex: 1;
    }

    .user-name {
      font-weight: 600;
    }

    .user-role {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .nav-menu {
      list-style: none;
      margin-top: 20px;
    }

    .nav-item {
      margin: 5px 10px;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      color: rgba(255, 255, 255, 0.9);
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.3s;
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .nav-link.active {
      background: var(--primary-light);
      color: white;
    }

    .nav-link i {
      width: 20px;
      text-align: center;
    }

    /* === CONTENU PRINCIPAL === */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 20px;
      transition: margin-left 0.3s ease;
    }

    /* === HEADER === */
    .top-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      background: var(--card-bg);
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px var(--shadow);
    }

    .header-left h1 {
      font-size: 1.5rem;
      color: var(--primary);
    }

    .header-stats {
      display: flex;
      gap: 20px;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 15px;
      background: var(--bg);
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .stat-value {
      font-weight: 700;
      color: var(--primary);
    }

    /* === CARTES === */
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 15px var(--shadow);
      border: 1px solid var(--border);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--bg);
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* === GRID SYSTEM === */
    .grid {
      display: grid;
      gap: 20px;
    }

    .grid-2 {
      grid-template-columns: repeat(2, 1fr);
    }

    .grid-3 {
      grid-template-columns: repeat(3, 1fr);
    }

    .grid-4 {
      grid-template-columns: repeat(4, 1fr);
    }

    /* === FORMULAIRES === */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-light);
      font-size: 0.95rem;
    }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s;
      background: white;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .form-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }

    /* === BOUTONS === */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
    }

    .btn i {
      font-size: 0.9em;
    }

    .btn-primary {
      background: var(--primary-light);
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #219653;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-warning:hover {
      background: #e67e22;
      transform: translateY(-2px);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--border);
      color: var(--text);
    }

    .btn-outline:hover {
      border-color: var(--primary-light);
      color: var(--primary-light);
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 0.85rem;
    }

    .btn-lg {
      padding: 16px 32px;
      font-size: 1.1rem;
    }

    /* === TABLEAUX === */
    .table-responsive {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }

    .table th {
      background: var(--bg);
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: var(--primary);
      border-bottom: 2px solid var(--border);
    }

    .table td {
      padding: 15px;
      border-bottom: 1px solid var(--border);
    }

    .table tr:hover {
      background: var(--bg);
    }

    .table tr:last-child td {
      border-bottom: none;
    }

    /* === BADGES === */
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-success {
      background: #d4edda;
      color: #155724;
    }

    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }

    /* === ALERTES === */
    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid var(--success);
    }

    .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid var(--danger);
    }

    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border-left: 4px solid var(--warning);
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border-left: 4px solid var(--info);
    }

    /* === MODALS === */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* === CARTE DE PRODUIT === */
    .product-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px var(--shadow);
    }

    .product-image {
      height: 180px;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      color: var(--text-light);
    }

    .product-info {
      padding: 20px;
    }

    .product-name {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--primary);
    }

    .product-price {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--success);
      margin-bottom: 5px;
    }

    .product-stock {
      font-size: 0.9rem;
      color: var(--text-light);
      margin-bottom: 15px;
    }

    .product-actions {
      display: flex;
      gap: 10px;
    }

    /* === TICKET DE CAISSE === */
    .ticket {
      background: white;
      border-radius: 8px;
      padding: 20px;
      font-family: 'Courier New', monospace;
      border: 2px solid var(--border);
    }

    .ticket-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px dashed var(--border);
    }

    .ticket-items {
      margin-bottom: 20px;
    }

    .ticket-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .ticket-total {
      border-top: 2px solid var(--border);
      padding-top: 10px;
      margin-top: 10px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
    }

    /* === CODE BARRE === */
    .barcode {
      font-family: 'Libre Barcode 128', cursive;
      font-size: 50px;
      text-align: center;
      margin: 20px 0;
      letter-spacing: 3px;
    }

    /* === RESPONSIVE === */
    @media (max-width: 1200px) {
      .grid-4 {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 992px) {
      .grid-3, .grid-4 {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .sidebar {
        transform: translateX(-100%);
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .menu-toggle {
        display: block;
      }
    }

    @media (max-width: 768px) {
      .grid-2, .grid-3, .grid-4 {
        grid-template-columns: 1fr;
      }
      
      .header-stats {
        flex-wrap: wrap;
      }
      
      .form-row {
        flex-direction: column;
        gap: 15px;
      }
    }

    /* === ANIMATIONS === */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.3s ease forwards;
    }

    /* === SCROLLBAR PERSONNALISÉE === */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-light);
    }

    /* === UTILITAIRES === */
    .d-none { display: none !important; }
    .d-flex { display: flex; }
    .align-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .gap-10 { gap: 10px; }
    .gap-20 { gap: 20px; }
    .mt-10 { margin-top: 10px; }
    .mt-20 { margin-top: 20px; }
    .mb-10 { margin-bottom: 10px; }
    .mb-20 { margin-bottom: 20px; }
    .ml-auto { margin-left: auto; }
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .text-success { color: var(--success); }
    .text-danger { color: var(--danger); }
    .text-warning { color: var(--warning); }
    .text-muted { color: var(--text-light); }
    .w-100 { width: 100%; }

    /* === PAGE DE CONNEXION === */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      padding: 20px;
    }

    .login-box {
      background: white;
      border-radius: 20px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .login-logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .login-logo h1 {
      color: var(--primary);
      font-size: 2rem;
    }

    .login-form .form-group {
      margin-bottom: 25px;
    }

    /* === NOTIFICATIONS === */
    .notification-center {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 3000;
      max-width: 350px;
    }

    .notification {
      background: white;
      border-radius: 10px;
      padding: 15px 20px;
      margin-bottom: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      border-left: 4px solid var(--primary);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* === LOADER === */
    .loader {
      display: inline-block;
      width: 50px;
      height: 50px;
      border: 3px solid var(--bg);
      border-radius: 50%;
      border-top-color: var(--primary-light);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* === MOBILE TOGGLE === */
    .menu-toggle {
      display: none;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--primary);
      cursor: pointer;
      padding: 10px;
    }

    @media (max-width: 992px) {
      .menu-toggle {
        display: block;
      }
    }

    /* === STYLES SPÉCIFIQUES POS === */
    .pos-product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
      max-height: 500px;
      overflow-y: auto;
      padding: 10px;
    }

    .pos-cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid var(--border);
    }

    .pos-cart-item:last-child {
      border-bottom: none;
    }

    .pos-quantity-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pos-quantity-btn {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: var(--primary-light);
      color: white;
      cursor: pointer;
    }

    .pos-quantity-btn:hover {
      background: var(--primary);
    }

    .pos-cart-summary {
      padding: 20px;
      background: var(--bg);
      border-radius: 8px;
      margin-top: 20px;
    }

    .pos-cart-totals {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid var(--border);
    }

    .pos-cart-total-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .pos-cart-total-row:last-child {
      font-weight: bold;
      font-size: 1.2em;
      color: var(--success);
    }

    .pos-payment-methods {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .pos-payment-btn {
      flex: 1;
      padding: 12px;
      text-align: center;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
    }

    .pos-payment-btn:hover {
      border-color: var(--primary-light);
      background: var(--bg);
    }

    .pos-payment-btn.active {
      border-color: var(--success);
      background: #d4edda;
    }

    .pos-search-box {
      position: relative;
      margin-bottom: 20px;
    }

    .pos-search-box i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
    }

    .pos-search-box input {
      padding-left: 45px;
    }

    .pos-category-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 10px;
    }

    .pos-category-btn {
      padding: 8px 16px;
      border: 2px solid var(--border);
      border-radius: 20px;
      background: white;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.3s;
    }

    .pos-category-btn:hover {
      border-color: var(--primary-light);
    }

    .pos-category-btn.active {
      background: var(--primary-light);
      color: white;
      border-color: var(--primary-light);
    }

    /* === FILTRE DATE === */
    .date-filter {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      margin-bottom: 20px;
    }

    .date-filter .form-group {
      margin-bottom: 0;
    }

    .date-filter label {
      font-size: 0.85rem;
    }

    /* === IMPORT/EXPORT === */
    .import-export-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    /* === NOUVEAUX STYLES === */
    .wholesale-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: var(--success);
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    
    /* Style pour approvisionnement */
    .approvisionnement-container {
      display: flex;
      gap: 20px;
    }
    
    .approvisionnement-left {
      flex: 1;
    }
    
    .approvisionnement-right {
      width: 300px;
    }
    
    .approvisionner-btn {
      width: 100%;
      margin-top: 20px;
    }
    
    /* Graphique */
    .chart-container {
      height: 300px;
      margin-top: 20px;
    }
    
    /* Filtre amélioré */
    .filter-results-container {
      margin-top: 20px;
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px var(--shadow);
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+128&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Système de connexion -->
  <div id="loginScreen" class="login-container">
    <div class="login-box">
      <div class="login-logo">
        <h1><i class="fas fa-store"></i> SHOP MIHARISOA</h1>
        <p class="text-muted">Système de Gestion de Point de Vente</p>
      </div>
      <form id="loginForm" class="login-form">
        <div class="form-group">
          <label class="form-label">Utilisateur</label>
          <select id="loginRole" class="form-control" required>
            <option value="">-- Sélectionner un rôle --</option>
            <option value="admin">Administrateur</option>
            <option value="manager">Gestionnaire</option>
            <option value="cashier">Caissier</option>
            <option value="viewer">Consultant</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Mot de passe</label>
          <input type="password" id="loginPassword" class="form-control" placeholder="Votre mot de passe" required>
        </div>
        <div class="form-group">
          <label class="form-label">Point de vente</label>
          <select id="loginPOS" class="form-control">
            <option value="main">PDV Principal</option>
            <option value="branch1">Succursale 1</option>
            <option value="branch2">Succursale 2</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary btn-lg w-100">
          <i class="fas fa-sign-in-alt"></i> Se connecter
        </button>
      </form>
    </div>
  </div>

  <!-- Application principale -->
  <div id="mainApp" class="app-container" style="display: none;">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2><i class="fas fa-store"></i> SHOP MIHARISOA</h2>
        <p class="company-name" id="companyName">SHOP MIHARISOA</p>
      </div>
      
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">A</div>
        <div class="user-details">
          <div class="user-name" id="userName">Administrateur</div>
          <div class="user-role" id="userRole">Administrateur</div>
        </div>
      </div>
      
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="#" class="nav-link active" data-page="dashboard">
            <i class="fas fa-tachometer-alt"></i> Tableau de bord
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-page="pos">
            <i class="fas fa-cash-register"></i> Point de vente
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-page="approvisionnement">
            <i class="fas fa-shopping-cart"></i> Approvisionnement
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-page="products">
            <i class="fas fa-boxes"></i> Produits
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-page="stock">
            <i class="fas fa-warehouse"></i> Stock
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-page="inventory">
            <i class="fas fa-clipboard-check"></i> Inventaire
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-page="customers">
            <i class="fas fa-users"></i> Clients
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-page="suppliers">
            <i class="fas fa-truck"></i> Fournisseurs
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-page="opex">
            <i class="fas fa-chart-pie"></i> OPEX
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-page="filter">
            <i class="fas fa-filter"></i> Filtre
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-page="cash">
            <i class="fas fa-money-bill-wave"></i> Caisse
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-page="cashconfig">
            <i class="fas fa-cog"></i> Configuration Caisse
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-page="settings">
            <i class="fas fa-cog"></i> Paramètres
          </a>
        </li>
      </ul>
      
      <div class="mt-20" style="padding: 0 20px;">
        <button id="logoutBtn" class="btn btn-danger w-100">
          <i class="fas fa-sign-out-alt"></i> Déconnexion
        </button>
      </div>
    </aside>

    <!-- Contenu principal -->
    <main class="main-content">
      <button class="menu-toggle" id="menuToggle">
        <i class="fas fa-bars"></i>
      </button>
      
      <div class="top-header">
        <div class="header-left">
          <h1 id="pageTitle">Tableau de bord</h1>
          <p class="text-muted" id="currentDateTime">Chargement...</p>
        </div>
        <div class="header-stats">
          <div class="stat-item">
            <i class="fas fa-shopping-cart text-primary"></i>
            <span>Ventes aujourd'hui: <strong id="salesToday">0</strong></span>
          </div>
          <div class="stat-item">
            <i class="fas fa-money-bill text-success"></i>
            <span>CA: <strong id="revenueToday">0 Ar</strong></span>
          </div>
          <div class="stat-item">
            <i class="fas fa-box text-warning"></i>
            <span>Articles: <strong id="totalArticles">0</strong></span>
          </div>
          <div class="stat-item">
            <i class="fas fa-cash-register text-danger"></i>
            <span>Solde caisse: <strong id="cashBalance">0 Ar</strong></span>
          </div>
        </div>
      </div>

      <!-- Contenu dynamique -->
      <div id="pageContent"></div>
    </main>
  </div>

  <!-- Centre de notifications -->
  <div class="notification-center" id="notificationCenter"></div>

  <!-- Modal générique -->
  <div class="modal" id="genericModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Titre</h3>
        <button class="btn btn-outline btn-sm" id="closeModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body" id="modalBody">
        Contenu du modal
      </div>
      <div class="modal-footer" id="modalFooter">
        <button class="btn btn-primary" id="modalConfirm">Confirmer</button>
      </div>
    </div>
  </div>

  <script>
    // === CONFIGURATION ===
    const APP_CONFIG = {
      appName: 'SHOP MIHARISOA',
      version: '2.0.0',
      currency: 'Ar',
      taxRate: 0,
      lowStockThreshold: 10,
      backupInterval: 300000,
      sessionTimeout: 3600000
    };

    // === UTILITAIRES ===
    const Utils = {
      formatNumber: (num) => new Intl.NumberFormat('fr-FR').format(num),
      formatCurrency: (amount) => `${new Intl.NumberFormat('fr-FR').format(amount)} ${APP_CONFIG.currency}`,
      formatDate: (date) => new Date(date).toLocaleDateString('fr-FR'),
      formatDateTime: (date) => new Date(date).toLocaleString('fr-FR'),
      generateId: (prefix = '') => `${prefix}${Date.now()}${Math.random().toString(36).substr(2, 9)}`,
      
      // MODIFICATION : Supprimer getOpexDateTime() et utiliser l'heure actuelle
      
      // Fonction : Vérifier si une OPEX existe déjà aujourd'hui
      opexExistsToday: (opexList, description, amount) => {
        const today = new Date().toISOString().split('T')[0];
        return opexList.some(opex => 
          opex.date.startsWith(today) && 
          opex.description === description && 
          opex.amount === amount
        );
      },
      
      // Fonction : Vérifier si un approvisionnement existe déjà aujourd'hui
      purchaseExistsToday: (purchaseList, supplierName, totalAmount) => {
        const today = new Date().toISOString().split('T')[0];
        return purchaseList.some(purchase => 
          purchase.date.startsWith(today) && 
          purchase.supplierName === supplierName && 
          purchase.total === totalAmount
        );
      },
      
      // Fonction pour générer le numéro de facture au format mmYYYY001
      generateInvoiceNumber: (sales) => {
        const now = new Date();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const year = now.getFullYear();
        
        const currentMonthSales = sales.filter(sale => {
          const saleDate = new Date(sale.date);
          return saleDate.getMonth() + 1 === now.getMonth() + 1 && 
                 saleDate.getFullYear() === now.getFullYear();
        });
        
        const sortedSales = currentMonthSales.sort((a, b) => 
          new Date(b.date) - new Date(a.date)
        );
        
        let sequenceNumber = 1;
        
        if (sortedSales.length > 0) {
          const lastSale = sortedSales[0];
          const lastInvoiceNumber = lastSale.invoiceNumber || lastSale.id;
          
          const match = lastInvoiceNumber.match(/\d{6}(\d{3})$/);
          if (match && match[1]) {
            sequenceNumber = parseInt(match[1]) + 1;
          }
        }
        
        const sequence = String(sequenceNumber).padStart(3, '0');
        return `${month}${year}${sequence}`;
      }
    };

    // === GESTION DES DONNÉES ===
    class DataManager {
      constructor() {
        this.storageKey = 'shop_miharisoa_data';
        this.backupKey = 'shop_miharisoa_backup';
        this.usersKey = 'shop_miharisoa_users';
        this.initData();
      }

      initData() {
        const defaultData = {
          version: APP_CONFIG.version,
          company: {
            name: 'SHOP MIHARISOA',
            address: 'Lot III À 68 E SAHAMASY  AMBALAVAO ',
            phone: '+261 34 04 702 00 /+261 34 20 042 12',
            email: '---',
            taxId: 'NIF 4012713844',
            statId: 'STAT 47110 11 2023 0 07046',
            logo: ''
          },
          products: [],
          categories: ['Alimentation', 'Hygiène', 'Boissons', 'Produits laitiers'],
          inventory: [],
          inventoryHistory: [],
          stockMovements: [],
          customers: [],
          suppliers: [],
          sales: [],
          purchases: [],
          expenses: [],
          opex: [],
          cashOperations: [],
          users: [],
          settings: {
            currency: APP_CONFIG.currency,
            taxRate: APP_CONFIG.taxRate,
            receiptHeader: 'Merci pour votre achat !',
            receiptFooter: 'Rendez-vous bientôt !',
            barcodeEnabled: true,
            autoBackup: true
          },
          cashRegister: {
            openingBalance: 0,
            closingBalance: 0,
            transactions: [],
            lastClosed: null
          },
          currentSession: {
            userId: null,
            posId: 'main',
            openedAt: null,
            salesCount: 0,
            revenue: 0
          }
        };

        const savedData = localStorage.getItem(this.storageKey);
        if (savedData) {
          try {
            this.data = JSON.parse(savedData);
            if (this.data.version !== APP_CONFIG.version) {
              this.migrateData();
            }
          } catch (e) {
            console.error('Erreur de chargement des données:', e);
            this.data = defaultData;
          }
        } else {
          this.data = defaultData;
        }

        this.loadUsers();
      }

      migrateData() {
        this.data.version = APP_CONFIG.version;
        this.save();
      }

      loadUsers() {
        const defaultUsers = [
          {
            id: 'admin',
            username: 'admin',
            password: 'admin123',
            name: 'Administrateur',
            role: 'admin',
            permissions: ['all'],
            posAccess: ['main', 'branch1', 'branch2']
          },
          {
            id: 'manager',
            username: 'manager',
            password: 'manager123',
            name: 'Gestionnaire',
            role: 'manager',
            permissions: ['read', 'write', 'approve'],
            posAccess: ['main']
          },
          {
            id: 'cashier',
            username: 'cashier',
            password: 'cashier123',
            name: 'Caissier',
            role: 'cashier',
            permissions: ['read', 'write'],
            posAccess: ['main']
          },
          {
            id: 'viewer',
            username: 'viewer',
            password: 'viewer123',
            name: 'Consultant',
            role: 'viewer',
            permissions: ['read'],
            posAccess: ['main']
          }
        ];

        const savedUsers = localStorage.getItem(this.usersKey);
        if (savedUsers) {
          try {
            this.data.users = JSON.parse(savedUsers);
          } catch (e) {
            this.data.users = defaultUsers;
          }
        } else {
          this.data.users = defaultUsers;
        }
      }

      save() {
        try {
          localStorage.setItem(this.storageKey, JSON.stringify(this.data));
          if (this.data.settings.autoBackup) {
            this.createBackup();
          }
          return true;
        } catch (e) {
          console.error('Erreur de sauvegarde:', e);
          this.showNotification('Erreur de sauvegarde des données', 'danger');
          return false;
        }
      }

      createBackup() {
        const timestamp = new Date().toISOString().split('T')[0];
        const backup = {
          timestamp: new Date().toISOString(),
          data: JSON.parse(JSON.stringify(this.data))
        };
        localStorage.setItem(`${this.backupKey}_${timestamp}`, JSON.stringify(backup));
      }

      exportBackup() {
        const timestamp = new Date().toISOString().split('T')[0];
        const backupData = {
          timestamp: new Date().toISOString(),
          app: APP_CONFIG.appName,
          version: APP_CONFIG.version,
          data: JSON.parse(JSON.stringify(this.data))
        };
        
        const dataStr = JSON.stringify(backupData, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const exportFileDefaultName = `pos_backup_${timestamp}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        this.showNotification('Backup exporté avec succès', 'success');
      }

      importBackup(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const importedData = JSON.parse(e.target.result);
            
            let dataToImport = null;
            
            if (importedData && importedData.data) {
              dataToImport = importedData.data;
            } else if (importedData && importedData.company) {
              dataToImport = importedData;
            } else if (importedData && importedData.products) {
              dataToImport = importedData;
            } else {
              this.showNotification('Format de fichier non reconnu.', 'danger');
              return;
            }
            
            if (!dataToImport.products) dataToImport.products = [];
            if (!dataToImport.customers) dataToImport.customers = [];
            if (!dataToImport.company) dataToImport.company = { name: 'SHOP MIHARISOA' };
            if (!dataToImport.settings) dataToImport.settings = this.data.settings;
            if (!dataToImport.cashRegister) dataToImport.cashRegister = this.data.cashRegister;
            if (!dataToImport.opex) dataToImport.opex = [];
            
            if (confirm(`Êtes-vous sûr de vouloir importer ce backup ?\n\nProduits: ${dataToImport.products.length}\nClients: ${dataToImport.customers.length}\nVentes: ${dataToImport.sales ? dataToImport.sales.length : 0}\n\nLes données actuelles seront remplacées.`)) {
              this.data = dataToImport;
              this.data.version = APP_CONFIG.version;
              
              this.data.users = this.data.users || this.data.users;
              
              this.save();
              this.showNotification('Backup importé avec succès ! Redémarrage...', 'success');
              setTimeout(() => location.reload(), 1000);
            }
            
          } catch (error) {
            console.error('Erreur lors de l\'import du backup:', error);
            this.showNotification('Erreur lors de l\'import du backup. Le fichier JSON est invalide.', 'danger');
          }
        };
        reader.onerror = () => {
          this.showNotification('Erreur lors de la lecture du fichier', 'danger');
        };
        reader.readAsText(file);
      }

      exportAllData() {
        const dataStr = JSON.stringify(this.data, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const exportFileDefaultName = `shop_miharisoa_data_${new Date().toISOString().split('T')[0]}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        this.showNotification('Toutes les données exportées avec succès', 'success');
      }

      showNotification(message, type = 'info') {
        const notificationCenter = document.getElementById('notificationCenter');
        const notification = document.createElement('div');
        notification.className = `notification alert-${type}`;
        notification.innerHTML = `
          <div class="d-flex align-center justify-between">
            <span>${message}</span>
            <button class="btn btn-sm btn-outline" onclick="this.parentElement.parentElement.remove()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;
        notificationCenter.appendChild(notification);
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 5000);
      }
    }

    // === GESTION D'APPLICATION ===
    class POSApplication {
      constructor() {
        this.dataManager = new DataManager();
        this.currentUser = null;
        this.currentPage = 'dashboard';
        this.cart = [];
        this.approvisionnementCart = [];
        this.currentCategory = 'all';
        this.wholesaleMode = false;
        this.init();
      }

      init() {
        this.checkAuth();
        this.setupEventListeners();
        this.updateDateTime();
        setInterval(() => this.updateDateTime(), 60000);
        setInterval(() => this.autoSave(), 30000);
        setInterval(() => this.checkSession(), 60000);
      }

      checkAuth() {
        const session = localStorage.getItem('shop_miharisoa_session');
        if (session) {
          try {
            const sessionData = JSON.parse(session);
            if (sessionData.expires > Date.now()) {
              this.currentUser = sessionData.user;
              this.showMainApp();
              this.loadPage('dashboard');
              return;
            }
          } catch (e) {
            console.error('Session invalide:', e);
          }
        }
        this.showLogin();
      }

      showLogin() {
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('mainApp').style.display = 'none';
      }

      showMainApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'flex';
        this.updateUserInfo();
        this.updateStats();
      }

      updateUserInfo() {
        if (this.currentUser) {
          document.getElementById('userName').textContent = this.currentUser.name;
          document.getElementById('userRole').textContent = this.currentUser.role;
          document.getElementById('userAvatar').textContent = this.currentUser.name.charAt(0);
          document.getElementById('companyName').textContent = this.dataManager.data.company.name;
        }
      }

      updateDateTime() {
        const now = new Date();
        const dateTimeStr = now.toLocaleDateString('fr-FR', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        document.getElementById('currentDateTime').textContent = dateTimeStr;
      }

      updateStats() {
        const today = new Date().toISOString().split('T')[0];
        const todaySales = this.dataManager.data.sales.filter(
          sale => sale.date.startsWith(today)
        );
        const salesCount = todaySales.length;
        const revenue = todaySales.reduce((sum, sale) => sum + sale.total, 0);
        const totalArticles = this.dataManager.data.products.reduce((sum, p) => sum + p.stock, 0);
        const cashBalance = this.dataManager.data.cashRegister.closingBalance;

        document.getElementById('salesToday').textContent = salesCount;
        document.getElementById('revenueToday').textContent = Utils.formatCurrency(revenue);
        document.getElementById('totalArticles').textContent = totalArticles;
        document.getElementById('cashBalance').textContent = Utils.formatCurrency(cashBalance);
      }

      setupEventListeners() {
        document.getElementById('loginForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleLogin();
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
          this.handleLogout();
        });

        document.querySelectorAll('.nav-link').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const page = e.currentTarget.dataset.page;
            this.loadPage(page);
          });
        });

        document.getElementById('menuToggle').addEventListener('click', () => {
          document.querySelector('.sidebar').classList.toggle('active');
        });

        document.getElementById('closeModal').addEventListener('click', () => {
          this.closeModal();
        });

        document.getElementById('modalConfirm').addEventListener('click', () => {
          this.closeModal();
        });

        document.getElementById('genericModal').addEventListener('click', (e) => {
          if (e.target === document.getElementById('genericModal')) {
            this.closeModal();
          }
        });
      }

      handleLogin() {
        const role = document.getElementById('loginRole').value;
        const password = document.getElementById('loginPassword').value;
        const posId = document.getElementById('loginPOS').value;

        const user = this.dataManager.data.users.find(
          u => u.role === role && u.password === password
        );

        if (user && user.posAccess.includes(posId)) {
          this.currentUser = user;
          
          const session = {
            user: user,
            posId: posId,
            expires: Date.now() + APP_CONFIG.sessionTimeout,
            createdAt: new Date().toISOString()
          };
          localStorage.setItem('shop_miharisoa_session', JSON.stringify(session));

          this.dataManager.data.currentSession = {
            userId: user.id,
            posId: posId,
            openedAt: new Date().toISOString(),
            salesCount: 0,
            revenue: 0
          };
          this.dataManager.save();

          this.showMainApp();
          this.dataManager.showNotification(`Bienvenue ${user.name} !`, 'success');
        } else {
          this.dataManager.showNotification('Identifiants incorrects', 'danger');
        }
      }

      handleLogout() {
        if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
          localStorage.removeItem('shop_miharisoa_session');
          this.currentUser = null;
          this.showLogin();
          this.dataManager.showNotification('Déconnexion réussie', 'success');
        }
      }

      checkSession() {
        const session = localStorage.getItem('shop_miharisoa_session');
        if (session) {
          const sessionData = JSON.parse(session);
          if (sessionData.expires < Date.now()) {
            this.dataManager.showNotification('Session expirée', 'warning');
            this.handleLogout();
          }
        }
      }

      loadPage(page) {
        this.currentPage = page;
        
        document.querySelectorAll('.nav-link').forEach(link => {
          link.classList.remove('active');
          if (link.dataset.page === page) {
            link.classList.add('active');
          }
        });

        const pageTitles = {
          dashboard: 'Tableau de bord',
          pos: 'Point de vente',
          approvisionnement: 'Approvisionnement',
          products: 'Produits',
          stock: 'Stock',
          inventory: 'Inventaire',
          customers: 'Clients',
          suppliers: 'Fournisseurs',
          opex: 'OPEX',
          filter: 'Filtre',
          cash: 'Caisse',
          cashconfig: 'Configuration Caisse',
          settings: 'Paramètres'
        };
        document.getElementById('pageTitle').textContent = pageTitles[page];

        this.renderPage(page);
      }

      renderPage(page) {
        const content = document.getElementById('pageContent');
        content.innerHTML = '';

        switch (page) {
          case 'dashboard':
            this.renderDashboard(content);
            break;
          case 'pos':
            this.renderPOS(content);
            break;
          case 'approvisionnement':
            this.renderApprovisionnement(content);
            break;
          case 'products':
            this.renderProducts(content);
            break;
          case 'stock':
            this.renderStock(content);
            break;
          case 'inventory':
            this.renderInventory(content);
            break;
          case 'customers':
            this.renderCustomers(content);
            break;
          case 'suppliers':
            this.renderSuppliers(content);
            break;
          case 'opex':
            this.renderOPEX(content);
            break;
          case 'filter':
            this.renderFilter(content);
            break;
          case 'cash':
            this.renderCash(content);
            break;
          case 'cashconfig':
            this.renderCashConfig(content);
            break;
          case 'settings':
            this.renderSettings(content);
            break;
          default:
            this.renderDashboard(content);
        }
      }
 // === STOCK ===
      renderStock(container) {
        container.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-warehouse"></i> Gestion du Stock</h3>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h4 class="card-title"><i class="fas fa-sign-in-alt"></i> Entrée stock</h4>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Date</label>
                  <input type="date" id="entryDate" class="form-control" value="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="form-group">
                  <label class="form-label">Produit</label>
                  <select id="entryProduct" class="form-control">
                    <option value="">-- Sélectionner un produit --</option>
                    ${this.dataManager.data.products.map(p => `
                      <option value="${p.id}">${p.name} (Stock: ${p.stock})</option>
                    `).join('')}
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Quantité</label>
                  <input type="number" id="entryQuantity" class="form-control" value="1" min="1">
                </div>
                <div class="form-group">
                  <label class="form-label">Prix unitaire</label>
                  <input type="number" id="entryUnitPrice" class="form-control" value="0" min="0" step="0.01">
                </div>
                <div class="form-group">
                  <label class="form-label">Montant</label>
                  <input type="text" id="entryAmount" class="form-control" value="0 Ar" readonly>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Observation</label>
                <textarea id="entryObservation" class="form-control" rows="2" placeholder="Notes sur cette entrée..."></textarea>
              </div>
              <div class="d-flex gap-10">
                <button class="btn btn-success" id="addEntry">
                  <i class="fas fa-plus"></i> Ajouter
                </button>
                <button class="btn btn-outline" id="resetEntry">
                  <i class="fas fa-redo"></i> Réinitialiser
                </button>
              </div>
            </div>
            
            <div class="card mt-20">
              <div class="card-header">
                <h4 class="card-title"><i class="fas fa-boxes"></i> Stock enregistré</h4>
              </div>
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Produit</th>
                      <th>Stock actuel</th>
                      <th>Valeur unitaire</th>
                      <th>Valeur totale</th>
                      <th>Dernière mise à jour</th>
                    </tr>
                  </thead>
                  <tbody id="stockSummary">
                  </tbody>
                </table>
              </div>
              <div class="text-right mt-10">
                <strong>Montant total du stock: </strong>
                <span id="totalStockValue" style="color: var(--success); font-size: 1.2rem;">0 Ar</span>
              </div>
            </div>
          </div>
        `;

        this.setupStockEventListeners();
        this.loadStockSummary();
        
        // Calcul automatique du montant
        document.getElementById('entryQuantity').addEventListener('input', this.calculateEntryAmount.bind(this));
        document.getElementById('entryUnitPrice').addEventListener('input', this.calculateEntryAmount.bind(this));
      }

      setupStockEventListeners() {
        document.getElementById('addEntry').addEventListener('click', () => {
          this.addStockEntry();
        });

        document.getElementById('resetEntry').addEventListener('click', () => {
          this.resetStockEntry();
        });
      }

      calculateEntryAmount() {
        const quantity = parseInt(document.getElementById('entryQuantity').value) || 0;
        const unitPrice = parseFloat(document.getElementById('entryUnitPrice').value) || 0;
        const amount = quantity * unitPrice;
        document.getElementById('entryAmount').value = Utils.formatCurrency(amount);
      }

      addStockEntry() {
        const productId = document.getElementById('entryProduct').value;
        const product = this.dataManager.data.products.find(p => p.id === productId);
        
        if (!product) {
          this.dataManager.showNotification('Veuillez sélectionner un produit', 'danger');
          return;
        }
        
        const quantity = parseInt(document.getElementById('entryQuantity').value) || 0;
        const unitPrice = parseFloat(document.getElementById('entryUnitPrice').value) || 0;
        
        if (quantity <= 0) {
          this.dataManager.showNotification('La quantité doit être supérieure à 0', 'danger');
          return;
        }
        
        // Créer le mouvement de stock
        const movement = {
          id: Utils.generateId('MVT_'),
          date: document.getElementById('entryDate').value,
          productId: productId,
          productName: product.name,
          type: 'entree',
          quantity: quantity,
          unitPrice: unitPrice,
          totalValue: quantity * unitPrice,
          observation: document.getElementById('entryObservation').value.trim(),
          createdBy: this.currentUser.id,
          createdAt: new Date().toISOString()
        };
        
        // Mettre à jour le stock du produit
        product.stock += quantity;
        
        // Ajouter au mouvement de stock
        this.dataManager.data.stockMovements.push(movement);
        
        // Enregistrer
        this.dataManager.save();
        
        // Mettre à jour l'affichage
        this.loadStockSummary();
        this.resetStockEntry();
        
        this.dataManager.showNotification('Entrée de stock enregistrée avec succès', 'success');
      }

      resetStockEntry() {
        document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('entryProduct').value = '';
        document.getElementById('entryQuantity').value = '1';
        document.getElementById('entryUnitPrice').value = '0';
        document.getElementById('entryAmount').value = '0 Ar';
        document.getElementById('entryObservation').value = '';
      }

      loadStockSummary() {
        const tbody = document.getElementById('stockSummary');
        const products = this.dataManager.data.products;
        let totalValue = 0;
        
        if (products.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center">Aucun produit en stock</td></tr>';
          document.getElementById('totalStockValue').textContent = '0 Ar';
          return;
        }
        
        let html = '';
        products.forEach(product => {
          const productValue = product.stock * (product.cost || 0);
          totalValue += productValue;
          
          // Trouver la dernière mise à jour
          const lastMovement = this.dataManager.data.stockMovements
            .filter(m => m.productId === product.id)
            .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
          
          html += `
            <tr>
              <td>${product.name}</td>
              <td><span class="badge ${product.stock <= APP_CONFIG.lowStockThreshold ? 'badge-danger' : 'badge-success'}">${product.stock}</span></td>
              <td>${Utils.formatCurrency(product.cost || 0)}</td>
              <td>${Utils.formatCurrency(productValue)}</td>
              <td>${lastMovement ? Utils.formatDate(lastMovement.date) : '-'}</td>
            </tr>
          `;
        });
        
        tbody.innerHTML = html;
        document.getElementById('totalStockValue').textContent = Utils.formatCurrency(totalValue);
      }

      // === INVENTAIRE ===
      renderInventory(container) {
        container.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-clipboard-check"></i> Inventaire</h3>
              <button class="btn btn-primary" id="startInventory">
                <i class="fas fa-play"></i> Démarrer inventaire
              </button>
            </div>
            
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> Cliquez sur "Démarrer inventaire" pour afficher les stocks théoriques
            </div>
            
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Produit</th>
                    <th>Stock théorique</th>
                    <th>Stock physique</th>
                    <th>Écart</th>
                    <th>Explication des écarts</th>
                  </tr>
                </thead>
                <tbody id="inventoryTable">
                  <tr><td colspan="5" class="text-center">Cliquez sur "Démarrer inventaire" pour commencer</td></tr>
                </tbody>
              </table>
            </div>
            
            <div class="text-right mt-20">
              <button class="btn btn-success" id="saveInventory" style="display: none;">
                <i class="fas fa-save"></i> Enregistrer l'inventaire
              </button>
            </div>
          </div>
          
          <div class="card mt-20">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-history"></i> Historique des inventaires</h3>
            </div>
            
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Référence</th>
                    <th>Produits vérifiés</th>
                    <th>Écarts</th>
                    <th>Valeur totale</th>
                    <th>Responsable</th>
                    <th>Détails</th>
                  </tr>
                </thead>
                <tbody id="inventoryHistory">
                </tbody>
              </table>
            </div>
          </div>
        `;

        this.setupInventoryEventListeners();
        this.loadInventoryHistory();
      }

      setupInventoryEventListeners() {
        document.getElementById('startInventory').addEventListener('click', () => {
          this.startInventory();
        });

        document.getElementById('saveInventory').addEventListener('click', () => {
          this.saveInventory();
        });
      }

      startInventory() {
        const tbody = document.getElementById('inventoryTable');
        const products = this.dataManager.data.products;
        
        let html = '';
        products.forEach(product => {
          html += `
            <tr>
              <td>${product.name}</td>
              <td>${product.stock}</td>
              <td>
                <input type="number" class="physical-stock" data-product-id="${product.id}" 
                       value="${product.stock}" min="0" style="width: 100px;">
              </td>
              <td class="difference-cell" data-product-id="${product.id}">0</td>
              <td>
                <input type="text" class="explanation" data-product-id="${product.id}" 
                       placeholder="Explication..." style="width: 100%;">
              </td>
            </tr>
          `;
        });
        
        tbody.innerHTML = html;
        document.getElementById('saveInventory').style.display = 'block';
        
        // Calculer les écarts
        document.querySelectorAll('.physical-stock').forEach(input => {
          input.addEventListener('input', () => {
            const productId = input.dataset.productId;
            const product = this.dataManager.data.products.find(p => p.id === productId);
            const physical = parseInt(input.value) || 0;
            const difference = physical - product.stock;
            
            document.querySelector(`.difference-cell[data-product-id="${productId}"]`).textContent = difference;
          });
        });
      }

      saveInventory() {
        const products = this.dataManager.data.products;
        let totalDifferences = 0;
        let totalValue = 0;
        let checkedProducts = 0;
        
        const inventoryData = products.map(product => {
          const physicalInput = document.querySelector(`.physical-stock[data-product-id="${product.id}"]`);
          const explanationInput = document.querySelector(`.explanation[data-product-id="${product.id}"]`);
          
          if (!physicalInput) return null;
          
          const physicalStock = parseInt(physicalInput.value) || 0;
          const difference = physicalStock - product.stock;
          const explanation = explanationInput ? explanationInput.value : '';
          
          totalDifferences += Math.abs(difference);
          totalValue += difference * (product.cost || 0);
          checkedProducts++;
          
          return {
            productId: product.id,
            productName: product.name,
            theoreticalStock: product.stock,
            physicalStock: physicalStock,
            difference: difference,
            explanation: explanation,
            unitValue: product.cost || 0,
            totalValue: difference * (product.cost || 0)
          };
        }).filter(item => item !== null);
        
        // Créer l'enregistrement d'inventaire
        const inventoryRecord = {
          id: Utils.generateId('INV_'),
          date: new Date().toISOString(),
          reference: `INV/${new Date().getFullYear()}/${String(this.dataManager.data.inventoryHistory.length + 1).padStart(4, '0')}`,
          products: inventoryData,
          totalDifferences: totalDifferences,
          totalValue: totalValue,
          checkedProducts: checkedProducts,
          performedBy: this.currentUser.id,
          performedAt: new Date().toISOString()
        };
        
        this.dataManager.data.inventoryHistory.push(inventoryRecord);
        this.dataManager.save();
        
        // Réinitialiser le tableau
        document.getElementById('inventoryTable').innerHTML = `
          <tr><td colspan="5" class="text-center">Inventaire enregistré le ${Utils.formatDateTime(new Date())}</td></tr>
        `;
        document.getElementById('saveInventory').style.display = 'none';
        
        // Mettre à jour l'historique
        this.loadInventoryHistory();
        
        this.dataManager.showNotification('Inventaire enregistré avec succès', 'success');
      }

      loadInventoryHistory() {
        const tbody = document.getElementById('inventoryHistory');
        const history = this.dataManager.data.inventoryHistory;
        
        if (history.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center">Aucun historique d\'inventaire</td></tr>';
          return;
        }
        
        let html = '';
        history.forEach(record => {
          html += `
            <tr>
              <td>${Utils.formatDate(record.date)}</td>
              <td>${record.reference}</td>
              <td>${record.checkedProducts}</td>
              <td>${record.totalDifferences}</td>
              <td>${Utils.formatCurrency(record.totalValue)}</td>
              <td>${this.getUserName(record.performedBy)}</td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="app.showInventoryDetails('${record.id}')">
                  <i class="fas fa-eye"></i> Afficher
                </button>
              </td>
            </tr>
          `;
        });
        
        tbody.innerHTML = html;
      }

      showInventoryDetails(inventoryId) {
        const record = this.dataManager.data.inventoryHistory.find(i => i.id === inventoryId);
        if (!record) return;
        
        const modal = document.getElementById('genericModal');
        modal.querySelector('#modalTitle').textContent = `Détails de l'inventaire ${record.reference}`;
        
        let detailsHtml = `
          <div class="alert alert-info">
            <strong>Date:</strong> ${Utils.formatDateTime(record.date)}<br>
            <strong>Référence:</strong> ${record.reference}<br>
            <strong>Responsable:</strong> ${this.getUserName(record.performedBy)}<br>
            <strong>Produits vérifiés:</strong> ${record.checkedProducts}<br>
            <strong>Écarts totaux:</strong> ${record.totalDifferences}<br>
            <strong>Valeur totale:</strong> ${Utils.formatCurrency(record.totalValue)}
          </div>
          <h4>Détails par produit</h4>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Produit</th>
                  <th>Stock théorique</th>
                  <th>Stock physique</th>
                  <th>Écart</th>
                  <th>Explication</th>
                  <th>Valeur</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        record.products.forEach(item => {
          detailsHtml += `
            <tr>
              <td>${item.productName}</td>
              <td>${item.theoreticalStock}</td>
              <td>${item.physicalStock}</td>
              <td>
                <span class="badge ${item.difference === 0 ? 'badge-success' : item.difference > 0 ? 'badge-info' : 'badge-danger'}">
                  ${item.difference}
                </span>
              </td>
              <td>${item.explanation || '-'}</td>
              <td>${Utils.formatCurrency(item.totalValue)}</td>
            </tr>
          `;
        });
        
        detailsHtml += `
              </tbody>
            </table>
          </div>
        `;
        
        modal.querySelector('#modalBody').innerHTML = detailsHtml;
        modal.querySelector('#modalFooter').innerHTML = `
          <button class="btn btn-primary" id="modalConfirm">Fermer</button>
        `;
        
        modal.classList.add('active');
      }

      // === CLIENTS ===
      renderCustomers(container) {
        container.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-users"></i> Gestion des Clients</h3>
              <button class="btn btn-primary" id="addCustomer">
                <i class="fas fa-plus"></i> Ajouter un client
              </button>
            </div>
            
            <div class="form-group">
              <input type="text" id="filterCustomers" class="form-control" placeholder="Rechercher un client...">
            </div>
            
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Nom</th>
                    <th>Contact</th>
                    <th>Adresse</th>
                    <th>Date d'inscription</th>
                    <th>Total achats</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="customersTable">
                </tbody>
              </table>
            </div>
          </div>
        `;

        this.loadCustomersTable();
        this.setupCustomersEventListeners();
      }

      setupCustomersEventListeners() {
        document.getElementById('addCustomer').addEventListener('click', () => {
          this.showCustomerModal();
        });

        document.getElementById('filterCustomers').addEventListener('input', (e) => {
          this.filterCustomersTable(e.target.value);
        });
      }

      loadCustomersTable() {
        const tbody = document.getElementById('customersTable');
        const customers = this.dataManager.data.customers;
        
        tbody.innerHTML = customers.map(customer => {
          return `
            <tr>
              <td>${customer.name}</td>
              <td>${customer.contact || '-'}</td>
              <td>${customer.address || '-'}</td>
              <td>${Utils.formatDate(customer.createdAt)}</td>
              <td>${Utils.formatCurrency(customer.totalPurchases || 0)}</td>
              <td>
                <div class="d-flex gap-10">
                  <button class="btn btn-sm btn-outline" onclick="app.editCustomer('${customer.id}')">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="app.deleteCustomer('${customer.id}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }

      filterCustomersTable(query) {
        const tbody = document.getElementById('customersTable');
        const customers = this.dataManager.data.customers;
        
        if (!query.trim()) {
          this.loadCustomersTable();
          return;
        }
        
        const filtered = customers.filter(customer =>
          customer.name.toLowerCase().includes(query.toLowerCase()) ||
          (customer.contact && customer.contact.includes(query)) ||
          (customer.address && customer.address.toLowerCase().includes(query.toLowerCase()))
        );
        
        tbody.innerHTML = filtered.map(customer => {
          return `
            <tr>
              <td>${customer.name}</td>
              <td>${customer.contact || '-'}</td>
              <td>${customer.address || '-'}</td>
              <td>${Utils.formatDate(customer.createdAt)}</td>
              <td>${Utils.formatCurrency(customer.totalPurchases || 0)}</td>
              <td>
                <div class="d-flex gap-10">
                  <button class="btn btn-sm btn-outline" onclick="app.editCustomer('${customer.id}')">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="app.deleteCustomer('${customer.id}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }

      showCustomerModal(customer = null) {
        const isEdit = !!customer;
        const modal = document.getElementById('genericModal');
        
        modal.querySelector('#modalTitle').textContent = isEdit ? 'Modifier le client' : 'Nouveau client';
        
        modal.querySelector('#modalBody').innerHTML = `
          <div class="form-group">
            <label class="form-label">Nom complet *</label>
            <input type="text" id="customerName" class="form-control" value="${customer ? customer.name : ''}" required>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Téléphone</label>
              <input type="tel" id="customerContact" class="form-control" value="${customer ? customer.contact || '' : ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" id="customerEmail" class="form-control" value="${customer ? customer.email || '' : ''}">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Adresse</label>
            <textarea id="customerAddress" class="form-control" rows="3">${customer ? customer.address || '' : ''}</textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">Notes</label>
            <textarea id="customerNotes" class="form-control" rows="2">${customer ? customer.notes || '' : ''}</textarea>
          </div>
        `;
        
        modal.querySelector('#modalFooter').innerHTML = `
          <button class="btn btn-primary" id="modalConfirm">
            ${isEdit ? 'Modifier' : 'Ajouter'}
          </button>
        `;
        
        modal.classList.add('active');
        
        modal.querySelector('#modalConfirm').onclick = () => {
          const customerData = {
            name: document.getElementById('customerName').value.trim(),
            contact: document.getElementById('customerContact').value.trim(),
            email: document.getElementById('customerEmail').value.trim(),
            address: document.getElementById('customerAddress').value.trim(),
            notes: document.getElementById('customerNotes').value.trim()
          };
          
          if (!customerData.name) {
            this.dataManager.showNotification('Le nom est obligatoire', 'danger');
            return;
          }
          
          if (isEdit) {
            Object.assign(customer, customerData);
            this.dataManager.showNotification('Client modifié avec succès', 'success');
          } else {
            customerData.id = Utils.generateId('CUST_');
            customerData.createdAt = new Date().toISOString();
            customerData.totalPurchases = 0;
            this.dataManager.data.customers.push(customerData);
            this.dataManager.showNotification('Client ajouté avec succès', 'success');
          }
          
          this.dataManager.save();
          this.loadCustomersTable();
          this.closeModal();
        };
      }

      editCustomer(customerId) {
        const customer = this.dataManager.data.customers.find(c => c.id === customerId);
        if (customer) {
          this.showCustomerModal(customer);
        }
      }

      deleteCustomer(customerId) {
        if (confirm('Êtes-vous sûr de vouloir supprimer ce client ?')) {
          const index = this.dataManager.data.customers.findIndex(c => c.id === customerId);
          if (index !== -1) {
            this.dataManager.data.customers.splice(index, 1);
            this.dataManager.save();
            this.loadCustomersTable();
            this.dataManager.showNotification('Client supprimé avec succès', 'success');
          }
        }
      }

      // === FOURNISSEURS ===
      renderSuppliers(container) {
        container.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-truck"></i> Gestion des Fournisseurs</h3>
              <button class="btn btn-primary" id="addSupplier">
                <i class="fas fa-plus"></i> Ajouter un fournisseur
              </button>
            </div>
            
            <div class="form-group">
              <input type="text" id="filterSuppliers" class="form-control" placeholder="Rechercher un fournisseur...">
            </div>
            
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Nom</th>
                    <th>Contact</th>
                    <th>Adresse</th>
                    <th>Produits fournis</th>
                    <th>Dernière livraison</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="suppliersTable">
                </tbody>
              </table>
            </div>
          </div>
        `;

        this.loadSuppliersTable();
        this.setupSuppliersEventListeners();
      }

      setupSuppliersEventListeners() {
        document.getElementById('addSupplier').addEventListener('click', () => {
          this.showSupplierModal();
        });

        document.getElementById('filterSuppliers').addEventListener('input', (e) => {
          this.filterSuppliersTable(e.target.value);
        });
      }

      loadSuppliersTable() {
        const tbody = document.getElementById('suppliersTable');
        const suppliers = this.dataManager.data.suppliers;
        
        tbody.innerHTML = suppliers.map(supplier => {
          const productsCount = this.dataManager.data.products.filter(p => p.supplierId === supplier.id).length;
          
          return `
            <tr>
              <td>${supplier.name}</td>
              <td>${supplier.contact || '-'}</td>
              <td>${supplier.address || '-'}</td>
              <td>${productsCount}</td>
              <td>${supplier.lastDelivery ? Utils.formatDate(supplier.lastDelivery) : '-'}</td>
              <td>
                <div class="d-flex gap-10">
                  <button class="btn btn-sm btn-outline" onclick="app.editSupplier('${supplier.id}')">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="app.deleteSupplier('${supplier.id}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }

      filterSuppliersTable(query) {
        const tbody = document.getElementById('suppliersTable');
        const suppliers = this.dataManager.data.suppliers;
        
        if (!query.trim()) {
          this.loadSuppliersTable();
          return;
        }
        
        const filtered = suppliers.filter(supplier =>
          supplier.name.toLowerCase().includes(query.toLowerCase()) ||
          (supplier.contact && supplier.contact.includes(query)) ||
          (supplier.address && supplier.address.toLowerCase().includes(query.toLowerCase()))
        );
        
        tbody.innerHTML = filtered.map(supplier => {
          const productsCount = this.dataManager.data.products.filter(p => p.supplierId === supplier.id).length;
          
          return `
            <tr>
              <td>${supplier.name}</td>
              <td>${supplier.contact || '-'}</td>
              <td>${supplier.address || '-'}</td>
              <td>${productsCount}</td>
              <td>${supplier.lastDelivery ? Utils.formatDate(supplier.lastDelivery) : '-'}</td>
              <td>
                <div class="d-flex gap-10">
                  <button class="btn btn-sm btn-outline" onclick="app.editSupplier('${supplier.id}')">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="app.deleteSupplier('${supplier.id}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }

      showSupplierModal(supplier = null) {
        const isEdit = !!supplier;
        const modal = document.getElementById('genericModal');
        
        modal.querySelector('#modalTitle').textContent = isEdit ? 'Modifier le fournisseur' : 'Nouveau fournisseur';
        
        modal.querySelector('#modalBody').innerHTML = `
          <div class="form-group">
            <label class="form-label">Nom de l'entreprise *</label>
            <input type="text" id="supplierName" class="form-control" value="${supplier ? supplier.name : ''}" required>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Contact principal</label>
              <input type="text" id="supplierContact" class="form-control" value="${supplier ? supplier.contact || '' : ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" id="supplierEmail" class="form-control" value="${supplier ? supplier.email || '' : ''}">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Adresse</label>
            <textarea id="supplierAddress" class="form-control" rows="3">${supplier ? supplier.address || '' : ''}</textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">Informations bancaires</label>
            <textarea id="supplierBankInfo" class="form-control" rows="2">${supplier ? supplier.bankInfo || '' : ''}</textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">Notes</label>
            <textarea id="supplierNotes" class="form-control" rows="2">${supplier ? supplier.notes || '' : ''}</textarea>
          </div>
        `;
        
        modal.querySelector('#modalFooter').innerHTML = `
          <button class="btn btn-primary" id="modalConfirm">
            ${isEdit ? 'Modifier' : 'Ajouter'}
          </button>
        `;
        
        modal.classList.add('active');
        
        modal.querySelector('#modalConfirm').onclick = () => {
          const supplierData = {
            name: document.getElementById('supplierName').value.trim(),
            contact: document.getElementById('supplierContact').value.trim(),
            email: document.getElementById('supplierEmail').value.trim(),
            address: document.getElementById('supplierAddress').value.trim(),
            bankInfo: document.getElementById('supplierBankInfo').value.trim(),
            notes: document.getElementById('supplierNotes').value.trim()
          };
          
          if (!supplierData.name) {
            this.dataManager.showNotification('Le nom est obligatoire', 'danger');
            return;
          }
          
          if (isEdit) {
            Object.assign(supplier, supplierData);
            this.dataManager.showNotification('Fournisseur modifié avec succès', 'success');
          } else {
            supplierData.id = Utils.generateId('SUPP_');
            supplierData.createdAt = new Date().toISOString();
            supplierData.productsSupplied = [];
            this.dataManager.data.suppliers.push(supplierData);
            this.dataManager.showNotification('Fournisseur ajouté avec succès', 'success');
          }
          
          this.dataManager.save();
          this.loadSuppliersTable();
          this.closeModal();
        };
      }

      editSupplier(supplierId) {
        const supplier = this.dataManager.data.suppliers.find(s => s.id === supplierId);
        if (supplier) {
          this.showSupplierModal(supplier);
        }
      }

      deleteSupplier(supplierId) {
        if (confirm('Êtes-vous sûr de vouloir supprimer ce fournisseur ?')) {
          const index = this.dataManager.data.suppliers.findIndex(s => s.id === supplierId);
          if (index !== -1) {
            this.dataManager.data.suppliers.splice(index, 1);
            this.dataManager.save();
            this.loadSuppliersTable();
            this.dataManager.showNotification('Fournisseur supprimé avec succès', 'success');
          }
        }
      }


      // === OPEX ===
      renderOPEX(container) {
        container.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-chart-pie"></i> Gestion des OPEX</h3>
              <button class="btn btn-primary" id="addOpex">
                <i class="fas fa-plus"></i> Ajouter une dépense
              </button>
              <div class="alert alert-warning" style="margin-top: 10px;">
                <i class="fas fa-exclamation-triangle"></i> 
                Chaque dépense OPEX est enregistrée UNE SEULE FOIS dans la caisse<br>
                L'heure est enregistrée avec l'heure actuelle
              </div>
            </div>
            
            <div class="grid grid-2">
              <div class="card">
                <div class="card-header">
                  <h4 class="card-title"><i class="fas fa-plus-circle"></i> Nouvelle dépense OPEX</h4>
                </div>
                <div class="form-group">
                  <label class="form-label">Date (heure actuelle)</label>
                  <input type="date" id="opexDate" class="form-control" value="${new Date().toISOString().split('T')[0]}">
                  <small class="text-muted">L'heure sera enregistrée avec l'heure actuelle du système</small>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Catégorie *</label>
                    <select id="opexCategory" class="form-control">
                      <option value="">-- Sélectionner --</option>
                      <option value="loyer">Loyer</option>
                      <option value="salaires">Salaires</option>
                      <option value="électricité">Électricité</option>
                      <option value="eau">Eau</option>
                      <option value="internet">Internet/Téléphone</option>
                      <option value="transport">Transport</option>
                      <option value="marketing">Marketing</option>
                      <option value="entretien">Entretien</option>
                      <option value="fournitures">Fournitures de bureau</option>
                      <option value="divers">Divers</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Montant *</label>
                    <input type="number" id="opexAmount" class="form-control" min="0" step="0.01" placeholder="Montant">
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">Description *</label>
                  <textarea id="opexDescription" class="form-control" rows="3" placeholder="Description de la dépense..."></textarea>
                </div>
                <div class="form-group">
                  <label class="form-label">Mode de paiement</label>
                  <select id="opexPayment" class="form-control">
                    <option value="cash">Espèces</option>
                    <option value="check">Chèque</option>
                    <option value="bank">Virement bancaire</option>
                    <option value="card">Carte bancaire</option>
                  </select>
                </div>
                <button class="btn btn-success w-100" id="saveOpex">
                  <i class="fas fa-save"></i> Enregistrer la dépense (enregistrement unique)
                </button>
              </div>
              
              <div class="card">
                <div class="card-header">
                  <h4 class="card-title"><i class="fas fa-chart-bar"></i> Statistiques OPEX</h4>
                </div>
                <div id="opexStats">
                  <div class="alert alert-info">
                    Les statistiques s'afficheront après l'ajout de dépenses
                  </div>
                </div>
              </div>
            </div>
            
            <div class="card mt-20">
              <div class="card-header">
                <h4 class="card-title"><i class="fas fa-list"></i> Historique des dépenses OPEX</h4>
              </div>
              
              <div class="date-filter">
                <div class="form-group">
                  <label class="form-label">Date début</label>
                  <input type="date" id="opexStartDate" class="form-control" value="${new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0]}">
                </div>
                <div class="form-group">
                  <label class="form-label">Date fin</label>
                  <input type="date" id="opexEndDate" class="form-control" value="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="form-group">
                  <label class="form-label">Catégorie</label>
                  <select id="opexFilterCategory" class="form-control">
                    <option value="">Toutes les catégories</option>
                    <option value="loyer">Loyer</option>
                    <option value="salaires">Salaires</option>
                    <option value="électricité">Électricité</option>
                    <option value="eau">Eau</option>
                    <option value="internet">Internet/Téléphone</option>
                    <option value="transport">Transport</option>
                    <option value="marketing">Marketing</option>
                    <option value="entretien">Entretien</option>
                    <option value="fournitures">Fournitures de bureau</option>
                    <option value="divers">Divers</option>
                  </select>
                </div>
                <button class="btn btn-primary" id="applyOpexFilter">
                  <i class="fas fa-filter"></i> Filtrer
                </button>
              </div>
              
              <div class="table-responsive mt-20">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Date/Heure</th>
                      <th>Catégorie</th>
                      <th>Description</th>
                      <th>Montant</th>
                      <th>Paiement</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="opexHistory">
                  </tbody>
                </table>
              </div>
              
              <div class="text-right mt-10">
                <strong>Total des dépenses OPEX: </strong>
                <span id="totalOpex" style="color: var(--danger); font-size: 1.2rem;">0 Ar</span>
              </div>
            </div>
          </div>
        `;
        
        this.setupOPEXEventListeners();
        this.loadOPEXHistory();
        this.updateOPEXStats();
      }

      setupOPEXEventListeners() {
        document.getElementById('saveOpex').addEventListener('click', () => {
          this.addOPEX();
        });

        document.getElementById('applyOpexFilter').addEventListener('click', () => {
          this.loadOPEXHistory();
        });
      }

      addOPEX() {
        const date = document.getElementById('opexDate').value;
        const category = document.getElementById('opexCategory').value;
        const amount = parseFloat(document.getElementById('opexAmount').value);
        const description = document.getElementById('opexDescription').value.trim();
        const payment = document.getElementById('opexPayment').value;
        
        if (!category) {
          this.dataManager.showNotification('Veuillez sélectionner une catégorie', 'danger');
          return;
        }
        
        if (!amount || amount <= 0) {
          this.dataManager.showNotification('Veuillez entrer un montant valide', 'danger');
          return;
        }
        
        if (!description) {
          this.dataManager.showNotification('Veuillez entrer une description', 'danger');
          return;
        }
        
        // VÉRIFICATION : S'assurer que l'OPEX n'existe pas déjà aujourd'hui
        if (Utils.opexExistsToday(this.dataManager.data.opex, description, amount)) {
          this.dataManager.showNotification('Cette dépense OPEX a déjà été enregistrée aujourd\'hui', 'danger');
          return;
        }
        
        // MODIFICATION : Créer une date avec l'heure actuelle
        const now = new Date();
        const selectedDate = new Date(date);
        // Garder la date sélectionnée mais avec l'heure actuelle
        selectedDate.setHours(now.getHours(), now.getMinutes(), now.getSeconds());
        
        const opex = {
          id: Utils.generateId('OPEX_'),
          date: selectedDate.toISOString(), // Date avec heure actuelle
          category: category,
          amount: amount,
          description: description,
          paymentMethod: payment,
          userId: this.currentUser.id,
          createdAt: new Date().toISOString()
        };
        
        // Ajouter aux OPEX (ENREGISTREMENT UNIQUE)
        this.dataManager.data.opex.push(opex);
        
        // Ajouter également aux dépenses générales
        this.dataManager.data.expenses.push({
          ...opex,
          type: 'opex'
        });
        
        // Mettre à jour la caisse si paiement en espèces (DÉDUCTION UNIQUE)
        if (payment === 'cash') {
          if (this.dataManager.data.cashRegister.closingBalance < amount) {
            this.dataManager.showNotification('Solde insuffisant en caisse', 'danger');
            return;
          }
          
          this.dataManager.data.cashRegister.closingBalance -= amount;
          
          // Enregistrer la transaction (UNIQUE)
          this.dataManager.data.cashRegister.transactions.push({
            id: Utils.generateId('TRX_'),
            date: selectedDate.toISOString(), // Même date avec heure actuelle
            type: 'expense',
            amount: -amount,
            description: `OPEX: ${category} - ${description}`,
            userId: this.currentUser.id
          });
        }
        
        this.dataManager.save();
        
        // Réinitialiser le formulaire
        document.getElementById('opexAmount').value = '';
        document.getElementById('opexDescription').value = '';
        
        // Mettre à jour l'affichage
        this.loadOPEXHistory();
        this.updateOPEXStats();
        this.updateStats();
        
        this.dataManager.showNotification('Dépense OPEX enregistrée UNE SEULE FOIS avec succès', 'success');
      }

      loadOPEXHistory() {
        const tbody = document.getElementById('opexHistory');
        const opexList = this.dataManager.data.opex;
        
        const startDate = document.getElementById('opexStartDate').value;
        const endDate = document.getElementById('opexEndDate').value;
        const filterCategory = document.getElementById('opexFilterCategory').value;
        
        let filteredOPEX = opexList;
        
        if (startDate && endDate) {
          filteredOPEX = opexList.filter(op => {
            const opDate = op.date;
            return opDate >= startDate && opDate <= endDate;
          });
        }
        
        if (filterCategory) {
          filteredOPEX = filteredOPEX.filter(op => op.category === filterCategory);
        }
        
        if (filteredOPEX.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center">Aucune dépense OPEX trouvée</td></tr>';
          document.getElementById('totalOpex').textContent = '0 Ar';
          return;
        }
        
        let html = '';
        let total = 0;
        
        filteredOPEX.slice().reverse().forEach(op => {
          total += op.amount;
          
          html += `
            <tr>
              <td>${Utils.formatDateTime(op.date)}</td>
              <td>
                <span class="badge badge-info">${op.category}</span>
              </td>
              <td>${op.description}</td>
              <td>${Utils.formatCurrency(op.amount)}</td>
              <td>${op.paymentMethod === 'cash' ? 'Espèces' : op.paymentMethod === 'check' ? 'Chèque' : op.paymentMethod === 'bank' ? 'Virement' : 'Carte'}</td>
              <td>
                <button class="btn btn-sm btn-danger" onclick="app.deleteOPEX('${op.id}')">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });
        
        tbody.innerHTML = html;
        document.getElementById('totalOpex').textContent = Utils.formatCurrency(total);
      }

      deleteOPEX(opexId) {
        if (confirm('Êtes-vous sûr de vouloir supprimer cette dépense OPEX ?')) {
          const index = this.dataManager.data.opex.findIndex(o => o.id === opexId);
          if (index !== -1) {
            const opex = this.dataManager.data.opex[index];
            
            // Si c'était un paiement en espèces, rembourser la caisse
            if (opex.paymentMethod === 'cash') {
              this.dataManager.data.cashRegister.closingBalance += opex.amount;
            }
            
            this.dataManager.data.opex.splice(index, 1);
            
            // Supprimer aussi des dépenses générales
            const expIndex = this.dataManager.data.expenses.findIndex(e => e.id === opexId);
            if (expIndex !== -1) {
              this.dataManager.data.expenses.splice(expIndex, 1);
            }
            
            this.dataManager.save();
            this.loadOPEXHistory();
            this.updateOPEXStats();
            this.updateStats();
            
            this.dataManager.showNotification('Dépense OPEX supprimée avec succès', 'success');
          }
        }
      }

      updateOPEXStats() {
        const statsContainer = document.getElementById('opexStats');
        const opexList = this.dataManager.data.opex;
        
        if (opexList.length === 0) {
          statsContainer.innerHTML = '<div class="alert alert-info">Aucune dépense OPEX enregistrée</div>';
          return;
        }
        
        // Calculer par catégorie
        const categoryTotals = {};
        let grandTotal = 0;
        
        opexList.forEach(op => {
          categoryTotals[op.category] = (categoryTotals[op.category] || 0) + op.amount;
          grandTotal += op.amount;
        });
        
        // Trier les catégories par montant décroissant
        const sortedCategories = Object.entries(categoryTotals)
          .sort((a, b) => b[1] - a[1]);
        
        let statsHtml = `
          <h4>Répartition par catégorie</h4>
          <div style="max-height: 200px; overflow-y: auto;">
        `;
        
        sortedCategories.forEach(([category, amount]) => {
          const percentage = ((amount / grandTotal) * 100).toFixed(1);
          statsHtml += `
            <div style="margin-bottom: 8px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                <span>${category}</span>
                <span>${Utils.formatCurrency(amount)} (${percentage}%)</span>
              </div>
              <div style="background: var(--border); height: 8px; border-radius: 4px;">
                <div style="background: var(--primary-light); width: ${percentage}%; height: 100%; border-radius: 4px;"></div>
              </div>
            </div>
          `;
        });
        
        statsHtml += `
          </div>
          <div class="mt-10" style="border-top: 1px solid var(--border); padding-top: 10px;">
            <strong>Total général: ${Utils.formatCurrency(grandTotal)}</strong>
          </div>
        `;
        
        statsContainer.innerHTML = statsHtml;
      }

      // === APPROVISIONNEMENT ===
      renderApprovisionnement(container) {
        container.innerHTML = `
          <div class="approvisionnement-container">
            <div class="approvisionnement-left">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title"><i class="fas fa-shopping-cart"></i> Achat de marchandises</h3>
                  <div class="alert alert-warning" style="margin-top: 10px;">
                    <i class="fas fa-exclamation-triangle"></i> 
                    Chaque approvisionnement est enregistré UNE SEULE FOIS dans la caisse
                  </div>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Fournisseur</label>
                  <select id="supplierSelect" class="form-control">
                    <option value="">-- Sélectionner un fournisseur --</option>
                    ${this.dataManager.data.suppliers.map(s => `
                      <option value="${s.id}">${s.name}</option>
                    `).join('')}
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Rechercher ou ajouter un produit</label>
                  <div class="pos-search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="approvisionnementSearch" class="form-control" placeholder="Nom du produit...">
                  </div>
                </div>
                
                <div class="table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Produit</th>
                        <th>Quantité</th>
                        <th>Prix unitaire</th>
                        <th>Total</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody id="approvisionnementItems">
                      <!-- Rempli dynamiquement -->
                    </tbody>
                  </table>
                </div>
                
                <div class="alert alert-info">
                  <i class="fas fa-info-circle"></i> 
                  Le montant total sera déduit de la caisse UNE SEULE FOIS lorsque vous cliquerez sur "Approvisionner"
                </div>
              </div>
            </div>
            
            <div class="approvisionnement-right">
              <div class="card">
                <div class="card-header">
                  <h4 class="card-title"><i class="fas fa-receipt"></i> Résumé</h4>
                </div>
                
                <div id="approvisionnementSummary">
                  <div class="pos-cart-summary">
                    <div class="pos-cart-totals">
                      <div class="pos-cart-total-row">
                        <span>Sous-total:</span>
                        <span id="approvisionnementSubtotal">0 Ar</span>
                      </div>
                      <div class="pos-cart-total-row">
                        <span>Total:</span>
                        <span id="approvisionnementTotal" style="color: var(--success); font-size: 1.2rem;">0 Ar</span>
                      </div>
                    </div>
                    
                    <div class="form-group">
                      <label class="form-label">Solde caisse actuel</label>
                      <input type="text" class="form-control" value="${Utils.formatCurrency(this.dataManager.data.cashRegister.closingBalance)}" readonly>
                    </div>
                    
                    <div class="form-group">
                      <label class="form-label">Solde après achat</label>
                      <input type="text" id="approvisionnementBalanceAfter" class="form-control" value="${Utils.formatCurrency(this.dataManager.data.cashRegister.closingBalance)}" readonly>
                    </div>
                    
                    <button class="btn btn-success btn-lg w-100 approvisionner-btn" id="approvisionnerBtn">
                      <i class="fas fa-check"></i> Approvisionner (enregistrement unique)
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        this.setupApprovisionnementEventListeners();
        this.updateApprovisionnementDisplay();
      }

      setupApprovisionnementEventListeners() {
        document.getElementById('approvisionnementSearch').addEventListener('input', (e) => {
          this.searchApprovisionnementProducts(e.target.value);
        });

        document.getElementById('approvisionnerBtn').addEventListener('click', () => {
          this.processApprovisionnement();
        });
      }

      searchApprovisionnementProducts(query) {
        const tbody = document.getElementById('approvisionnementItems');
        
        if (!query.trim()) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center text-muted">
                <i class="fas fa-search fa-2x mb-10"></i>
                <p>Rechercher un produit pour l'ajouter</p>
              </td>
            </tr>
          `;
          return;
        }

        const products = this.dataManager.data.products.filter(product =>
          product.name.toLowerCase().includes(query.toLowerCase()) ||
          (product.category && product.category.toLowerCase().includes(query.toLowerCase()))
        );

        if (products.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center text-muted">
                <i class="fas fa-box fa-2x mb-10"></i>
                <p>Aucun produit trouvé</p>
                <button class="btn btn-primary btn-sm mt-10" onclick="app.showProductModal()">
                  <i class="fas fa-plus"></i> Ajouter un nouveau produit
                </button>
              </td>
            </tr>
          `;
          return;
        }

        let html = '';
        products.forEach(product => {
          const existingItem = this.approvisionnementCart.find(item => item.id === product.id);
          html += `
            <tr>
              <td>${product.name}</td>
              <td>
                <input type="number" class="form-control" id="quantity_${product.id}" 
                       value="${existingItem ? existingItem.quantity : 0}" min="0" 
                       onchange="app.updateApprovisionnementQuantity('${product.id}')" 
                       style="width: 100px;">
              </td>
              <td>
                <input type="number" class="form-control" id="price_${product.id}" 
                       value="${existingItem ? existingItem.cost : product.cost || 0}" min="0" 
                       onchange="app.updateApprovisionnementPrice('${product.id}')" 
                       style="width: 150px;">
              </td>
              <td id="total_${product.id}">
                ${Utils.formatCurrency((existingItem ? existingItem.quantity : 0) * (existingItem ? existingItem.cost : product.cost || 0))}
              </td>
              <td>
                <button class="btn btn-danger btn-sm" onclick="app.removeFromApprovisionnement('${product.id}')">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });

        tbody.innerHTML = html;
      }

      updateApprovisionnementQuantity(productId) {
        const quantity = parseInt(document.getElementById(`quantity_${productId}`).value) || 0;
        const price = parseFloat(document.getElementById(`price_${productId}`).value) || 0;
        
        const existingIndex = this.approvisionnementCart.findIndex(item => item.id === productId);
        
        if (quantity > 0) {
          const product = this.dataManager.data.products.find(p => p.id === productId);
          
          if (existingIndex !== -1) {
            this.approvisionnementCart[existingIndex].quantity = quantity;
            this.approvisionnementCart[existingIndex].cost = price;
          } else {
            this.approvisionnementCart.push({
              ...product,
              quantity: quantity,
              cost: price
            });
          }
          
          document.getElementById(`total_${productId}`).textContent = Utils.formatCurrency(quantity * price);
        } else {
          if (existingIndex !== -1) {
            this.approvisionnementCart.splice(existingIndex, 1);
            document.getElementById(`total_${productId}`).textContent = '0 Ar';
          }
        }
        
        this.updateApprovisionnementDisplay();
      }

      updateApprovisionnementPrice(productId) {
        const quantity = parseInt(document.getElementById(`quantity_${productId}`).value) || 0;
        const price = parseFloat(document.getElementById(`price_${productId}`).value) || 0;
        
        const existingIndex = this.approvisionnementCart.findIndex(item => item.id === productId);
        
        if (existingIndex !== -1) {
          this.approvisionnementCart[existingIndex].cost = price;
          document.getElementById(`total_${productId}`).textContent = Utils.formatCurrency(quantity * price);
        }
        
        this.updateApprovisionnementDisplay();
      }

      removeFromApprovisionnement(productId) {
        const existingIndex = this.approvisionnementCart.findIndex(item => item.id === productId);
        if (existingIndex !== -1) {
          this.approvisionnementCart.splice(existingIndex, 1);
          document.getElementById(`quantity_${productId}`).value = 0;
          document.getElementById(`total_${productId}`).textContent = '0 Ar';
          this.updateApprovisionnementDisplay();
        }
      }

      updateApprovisionnementDisplay() {
        const subtotal = this.approvisionnementCart.reduce((sum, item) => sum + (item.cost * item.quantity), 0);
        const total = subtotal;
        const currentBalance = this.dataManager.data.cashRegister.closingBalance;
        const balanceAfter = currentBalance - total;

        document.getElementById('approvisionnementSubtotal').textContent = Utils.formatCurrency(subtotal);
        document.getElementById('approvisionnementTotal').textContent = Utils.formatCurrency(total);
        document.getElementById('approvisionnementBalanceAfter').value = Utils.formatCurrency(balanceAfter);
      }

      processApprovisionnement() {
        if (this.approvisionnementCart.length === 0) {
          this.dataManager.showNotification('Aucun produit à approvisionner', 'warning');
          return;
        }

        const supplierId = document.getElementById('supplierSelect').value;
        const supplier = this.dataManager.data.suppliers.find(s => s.id === supplierId);
        const supplierName = supplier ? supplier.name : 'Inconnu';

        const subtotal = this.approvisionnementCart.reduce((sum, item) => sum + (item.cost * item.quantity), 0);
        const total = subtotal;

        // VÉRIFICATION : S'assurer que l'approvisionnement n'existe pas déjà aujourd'hui
        if (Utils.purchaseExistsToday(this.dataManager.data.purchases, supplierName, total)) {
          this.dataManager.showNotification('Cet approvisionnement a déjà été enregistré aujourd\'hui', 'danger');
          return;
        }

        // Vérifier le solde de la caisse
        if (this.dataManager.data.cashRegister.closingBalance < total) {
          this.dataManager.showNotification('Solde insuffisant en caisse', 'danger');
          return;
        }

        // Créer l'achat
        const purchase = {
          id: Utils.generateId('PURCH_'),
          date: new Date().toISOString(),
          supplierId: supplierId,
          supplierName: supplierName,
          items: this.approvisionnementCart.map(item => ({
            productId: item.id,
            name: item.name,
            quantity: item.quantity,
            cost: item.cost,
            total: item.cost * item.quantity
          })),
          subtotal: subtotal,
          total: total,
          userId: this.currentUser.id
        };

        // Mettre à jour le stock et enregistrer les prix unitaires
        for (const item of this.approvisionnementCart) {
          const product = this.dataManager.data.products.find(p => p.id === item.id);
          if (product) {
            product.stock += item.quantity;
            product.cost = item.cost; // Mettre à jour le coût
            
            // Ajouter un mouvement de stock automatique
            const stockMovement = {
              id: Utils.generateId('MVT_'),
              date: new Date().toISOString(),
              productId: product.id,
              productName: product.name,
              type: 'entree',
              quantity: item.quantity,
              unitPrice: item.cost,
              totalValue: item.quantity * item.cost,
              reason: `Approvisionnement - ${supplierName}`,
              createdBy: this.currentUser.id,
              createdAt: new Date().toISOString()
            };
            this.dataManager.data.stockMovements.push(stockMovement);
          }
        }

        // Enregistrer l'achat
        this.dataManager.data.purchases.push(purchase);
        
        // Ajouter aux dépenses (ENREGISTREMENT UNIQUE)
        this.dataManager.data.expenses.push({
          id: purchase.id,
          date: new Date().toISOString(),
          type: 'purchase',
          category: 'approvisionnement',
          amount: total,
          description: `Approvisionnement - ${supplierName}`,
          paymentMethod: 'cash',
          userId: this.currentUser.id
        });
        
        // Mettre à jour la caisse (DÉDUCTION UNIQUE)
        this.dataManager.data.cashRegister.closingBalance -= total;
        
        // Enregistrer la transaction (UNIQUE)
        this.dataManager.data.cashRegister.transactions.push({
          id: Utils.generateId('TRX_'),
          date: new Date().toISOString(),
          type: 'purchase',
          amount: -total,
          description: `Approvisionnement - ${supplierName}`,
          userId: this.currentUser.id
        });

        // Mettre à jour le fournisseur
        if (supplier) {
          supplier.lastDelivery = new Date().toISOString();
        }

        this.dataManager.save();
        
        // Réinitialiser
        this.approvisionnementCart = [];
        document.getElementById('approvisionnementSearch').value = '';
        document.getElementById('supplierSelect').value = '';
        this.updateApprovisionnementDisplay();
        
        const tbody = document.getElementById('approvisionnementItems');
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center text-muted">
              <i class="fas fa-check-circle fa-2x mb-10 text-success"></i>
              <p>Approvisionnement effectué avec succès (enregistrement unique)</p>
            </td>
          </tr>
        `;
        
        this.dataManager.showNotification('Approvisionnement enregistré UNE SEULE FOIS avec succès', 'success');
        this.updateStats();
        this.loadAllProducts();
      }

            // === POINT DE VENTE ===
      renderPOS(container) {
        container.innerHTML = `
          <div class="grid grid-3">
            <div class="card" style="grid-column: span 2;">
              <div class="card-header">
                <h3 class="card-title"><i class="fas fa-shopping-cart"></i> Panier</h3>
                <div class="wholesale-toggle">
                  <label>Activer prix de gros</label>
                  <label class="toggle-switch">
                    <input type="checkbox" id="wholesaleToggle" ${this.wholesaleMode ? 'checked' : ''}>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <button class="btn btn-danger" id="clearCart">
                  <i class="fas fa-trash"></i> Vider
                </button>
              </div>
              
              <div class="form-group">
                <label class="form-label">Client</label>
                <select id="customerSelect" class="form-control">
                  <option value="">-- Sélectionner un client --</option>
                  ${this.dataManager.data.customers.map(c => `
                    <option value="${c.id}">${c.name}</option>
                  `).join('')}
                  <option value="CUST_GUEST">Client invité</option>
                </select>
              </div>
              
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Produit</th>
                      <th>Prix</th>
                      <th>Quantité</th>
                      <th>Total</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="cartItems">
                    <!-- Rempli dynamiquement -->
                  </tbody>
                </table>
              </div>
              
              <div class="pos-cart-summary">
                <div class="pos-cart-totals">
                  <div class="pos-cart-total-row">
                    <span>Sous-total:</span>
                    <span id="subtotal">0 Ar</span>
                  </div>
                  <div class="pos-cart-total-row">
                    <span>TVA:</span>
                    <span id="taxAmount">0 Ar</span>
                    <input type="number" id="manualTax" class="form-control" style="width: 100px; display: inline-block;" placeholder="% TVA" value="${this.dataManager.data.settings.taxRate || 0}">
                  </div>
                  <div class="pos-cart-total-row">
                    <span>Total:</span>
                    <span id="totalAmount" style="color: var(--success); font-size: 1.3rem;">0 Ar</span>
                  </div>
                </div>
                
                <div class="pos-payment-methods">
                  <div class="pos-payment-btn" data-method="cash">
                    <i class="fas fa-money-bill-wave"></i>
                    <div>Espèces</div>
                  </div>
                  <div class="pos-payment-btn" data-method="card">
                    <i class="fas fa-credit-card"></i>
                    <div>Carte</div>
                  </div>
                  <div class="pos-payment-btn" data-method="check">
                    <i class="fas fa-money-check"></i>
                    <div>Chèque</div>
                  </div>
                </div>
                
                <button class="btn btn-success btn-lg w-100 mt-20" id="processSale">
                  <i class="fas fa-check"></i> Procéder au paiement
                </button>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h3 class="card-title"><i class="fas fa-search"></i> Recherche produit</h3>
              </div>
              
              <div class="pos-search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="productSearch" class="form-control" placeholder="Code barre, nom du produit...">
              </div>
              
              <div class="pos-category-filter" id="categoryFilter">
                <button class="pos-category-btn active" data-category="all">Tous</button>
                <!-- Catégories ajoutées dynamiquement -->
              </div>
              
              <div id="productResults" class="pos-product-grid">
                <!-- Rempli dynamiquement -->
              </div>
            </div>
          </div>
        `;

        this.setupPOSEventListeners();
        this.loadProductCategories();
        this.loadAllProducts();
        this.updateCartDisplay();
      }

      setupPOSEventListeners() {
        document.getElementById('clearCart').addEventListener('click', () => {
          this.cart = [];
          this.updateCartDisplay();
          this.dataManager.showNotification('Panier vidé', 'warning');
        });

        document.getElementById('processSale').addEventListener('click', () => {
          this.processSale();
        });

        document.getElementById('productSearch').addEventListener('input', (e) => {
          this.searchProducts(e.target.value);
        });

        document.querySelectorAll('.pos-payment-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            document.querySelectorAll('.pos-payment-btn').forEach(b => b.classList.remove('active'));
            e.currentTarget.classList.add('active');
          });
        });

        document.getElementById('wholesaleToggle').addEventListener('change', (e) => {
          this.wholesaleMode = e.target.checked;
          this.updateCartDisplay();
          this.dataManager.showNotification(`Mode ${this.wholesaleMode ? 'gros' : 'détail'} activé`, 'info');
        });

        document.getElementById('manualTax').addEventListener('input', (e) => {
          const taxRate = parseFloat(e.target.value) || 0;
          if (taxRate >= 0 && taxRate <= 100) {
            this.updateCartDisplay();
          }
        });
      }

      loadProductCategories() {
        const categoryFilter = document.getElementById('categoryFilter');
        const products = this.dataManager.data.products;
        
        const categories = ['all', ...new Set(products.map(p => p.category).filter(c => c))];
        
        let html = '';
        categories.forEach(category => {
          const displayName = category === 'all' ? 'Tous' : category;
          const activeClass = category === 'all' ? 'active' : '';
          html += `<button class="pos-category-btn ${activeClass}" data-category="${category}">${displayName}</button>`;
        });
        
        categoryFilter.innerHTML = html;
        
        categoryFilter.querySelectorAll('.pos-category-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            document.querySelectorAll('.pos-category-btn').forEach(b => b.classList.remove('active'));
            e.currentTarget.classList.add('active');
            this.currentCategory = e.currentTarget.dataset.category;
            this.filterProductsByCategory();
          });
        });
      }

      loadAllProducts() {
        const productResults = document.getElementById('productResults');
        const products = this.dataManager.data.products;
        
        if (products.length === 0) {
          productResults.innerHTML = '<div class="alert alert-warning w-100">Aucun produit disponible</div>';
          return;
        }
        
        let html = '';
        products.forEach(product => {
          const stockClass = product.stock <= APP_CONFIG.lowStockThreshold ? 'badge-danger' : 
                           product.stock <= APP_CONFIG.lowStockThreshold * 2 ? 'badge-warning' : 'badge-success';
          
          html += `
            <div class="product-card" onclick="app.addToCart(${JSON.stringify(product).replace(/"/g, '&quot;')})">
              <div class="product-image">
                <i class="fas fa-box"></i>
              </div>
              <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div class="product-price">
                  ${product.wholesalePrice ? 
                    `<div>Détail: ${Utils.formatCurrency(product.price)}</div>
                     <div>Gros: ${Utils.formatCurrency(product.wholesalePrice)}</div>` : 
                    Utils.formatCurrency(product.price)}
                </div>
                <div class="product-stock">
                  Stock: <span class="badge ${stockClass}">${product.stock}</span>
                </div>
                ${product.category ? `<div class="text-muted" style="font-size: 0.8rem;">${product.category}</div>` : ''}
              </div>
            </div>
          `;
        });
        
        productResults.innerHTML = html;
      }

      filterProductsByCategory() {
        const productResults = document.getElementById('productResults');
        const products = this.dataManager.data.products;
        
        let filteredProducts = products;
        if (this.currentCategory !== 'all') {
          filteredProducts = products.filter(p => p.category === this.currentCategory);
        }
        
        if (filteredProducts.length === 0) {
          productResults.innerHTML = '<div class="alert alert-warning w-100">Aucun produit dans cette catégorie</div>';
          return;
        }
        
        let html = '';
        filteredProducts.forEach(product => {
          const stockClass = product.stock <= APP_CONFIG.lowStockThreshold ? 'badge-danger' : 
                           product.stock <= APP_CONFIG.lowStockThreshold * 2 ? 'badge-warning' : 'badge-success';
          
          html += `
            <div class="product-card" onclick="app.addToCart(${JSON.stringify(product).replace(/"/g, '&quot;')})">
              <div class="product-image">
                <i class="fas fa-box"></i>
              </div>
              <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div class="product-price">
                  ${product.wholesalePrice ? 
                    `<div>Détail: ${Utils.formatCurrency(product.price)}</div>
                     <div>Gros: ${Utils.formatCurrency(product.wholesalePrice)}</div>` : 
                    Utils.formatCurrency(product.price)}
                </div>
                <div class="product-stock">
                  Stock: <span class="badge ${stockClass}">${product.stock}</span>
                </div>
                ${product.category ? `<div class="text-muted" style="font-size: 0.8rem;">${product.category}</div>` : ''}
              </div>
            </div>
          `;
        });
        
        productResults.innerHTML = html;
      }

      searchProducts(query) {
        const productResults = document.getElementById('productResults');
        const products = this.dataManager.data.products;
        
        if (!query.trim()) {
          this.filterProductsByCategory();
          return;
        }

        let filteredProducts = products;
        if (this.currentCategory !== 'all') {
          filteredProducts = products.filter(p => p.category === this.currentCategory);
        }
        
        filteredProducts = filteredProducts.filter(product =>
          product.name.toLowerCase().includes(query.toLowerCase()) ||
          (product.barcode && product.barcode.includes(query)) ||
          (product.category && product.category.toLowerCase().includes(query.toLowerCase()))
        );

        if (filteredProducts.length === 0) {
          productResults.innerHTML = '<div class="alert alert-warning w-100">Aucun produit trouvé</div>';
          return;
        }

        let html = '';
        filteredProducts.forEach(product => {
          const stockClass = product.stock <= APP_CONFIG.lowStockThreshold ? 'badge-danger' : 
                           product.stock <= APP_CONFIG.lowStockThreshold * 2 ? 'badge-warning' : 'badge-success';
          
          html += `
            <div class="product-card" onclick="app.addToCart(${JSON.stringify(product).replace(/"/g, '&quot;')})">
              <div class="product-image">
                <i class="fas fa-box"></i>
              </div>
              <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div class="product-price">
                  ${product.wholesalePrice ? 
                    `<div>Détail: ${Utils.formatCurrency(product.price)}</div>
                     <div>Gros: ${Utils.formatCurrency(product.wholesalePrice)}</div>` : 
                    Utils.formatCurrency(product.price)}
                </div>
                <div class="product-stock">
                  Stock: <span class="badge ${stockClass}">${product.stock}</span>
                </div>
                ${product.category ? `<div class="text-muted" style="font-size: 0.8rem;">${product.category}</div>` : ''}
              </div>
            </div>
          `;
        });
        
        productResults.innerHTML = html;
      }

      updateCartDisplay() {
        const tbody = document.getElementById('cartItems');
        const subtotal = this.cart.reduce((sum, item) => {
          const price = this.wholesaleMode && item.wholesalePrice ? item.wholesalePrice : item.price;
          return sum + (price * item.quantity);
        }, 0);
        
        const taxRate = parseFloat(document.getElementById('manualTax').value) || this.dataManager.data.settings.taxRate || 0;
        const tax = subtotal * (taxRate / 100);
        const total = subtotal + tax;

        if (this.cart.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center text-muted">
                <i class="fas fa-shopping-cart fa-2x mb-10"></i>
                <p>Panier vide</p>
              </td>
            </tr>
          `;
        } else {
          tbody.innerHTML = this.cart.map((item, index) => {
            const price = this.wholesaleMode && item.wholesalePrice ? item.wholesalePrice : item.price;
            const totalItem = price * item.quantity;
            return `
              <tr>
                <td>${item.name} ${this.wholesaleMode && item.wholesalePrice ? '<span class="badge badge-info">Gros</span>' : ''}</td>
                <td>${Utils.formatCurrency(price)}</td>
                <td>
                  <div class="pos-quantity-control">
                    <button class="pos-quantity-btn" onclick="app.updateQuantity(${index}, -1)">
                      <i class="fas fa-minus"></i>
                    </button>
                    <span>${item.quantity}</span>
                    <button class="pos-quantity-btn" onclick="app.updateQuantity(${index}, 1)">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                </td>
                <td>${Utils.formatCurrency(totalItem)}</td>
                <td>
                  <button class="btn btn-danger btn-sm" onclick="app.removeFromCart(${index})">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            `;
          }).join('');
        }

        document.getElementById('subtotal').textContent = Utils.formatCurrency(subtotal);
        document.getElementById('taxAmount').textContent = Utils.formatCurrency(tax);
        document.getElementById('totalAmount').textContent = Utils.formatCurrency(total);
      }

      addToCart(product) {
        if (product.stock <= 0) {
          this.dataManager.showNotification(`${product.name} est en rupture de stock`, 'danger');
          return;
        }

        const existingItem = this.cart.find(item => item.id === product.id);
        if (existingItem) {
          if (existingItem.quantity + 1 > product.stock) {
            this.dataManager.showNotification(`Stock insuffisant pour ${product.name}`, 'danger');
            return;
          }
          existingItem.quantity += 1;
        } else {
          this.cart.push({
            ...product,
            quantity: 1
          });
        }
        this.updateCartDisplay();
        this.dataManager.showNotification(`${product.name} ajouté au panier`, 'success');
      }

      removeFromCart(index) {
        const item = this.cart[index];
        this.cart.splice(index, 1);
        this.updateCartDisplay();
        this.dataManager.showNotification(`${item.name} retiré du panier`, 'warning');
      }

      updateQuantity(index, delta) {
        const item = this.cart[index];
        const product = this.dataManager.data.products.find(p => p.id === item.id);
        
        const newQuantity = item.quantity + delta;
        if (newQuantity < 1) {
          this.removeFromCart(index);
          return;
        }
        
        if (newQuantity > product.stock) {
          this.dataManager.showNotification(`Stock insuffisant pour ${product.name}`, 'danger');
          return;
        }
        
        item.quantity = newQuantity;
        this.updateCartDisplay();
      }

      processSale() {
        if (this.cart.length === 0) {
          this.dataManager.showNotification('Le panier est vide', 'warning');
          return;
        }

        const paymentBtn = document.querySelector('.pos-payment-btn.active');
        if (!paymentBtn) {
          this.dataManager.showNotification('Veuillez sélectionner un mode de paiement', 'warning');
          return;
        }
        const paymentMethod = paymentBtn.dataset.method;

        const subtotal = this.cart.reduce((sum, item) => {
          const price = this.wholesaleMode && item.wholesalePrice ? item.wholesalePrice : item.price;
          return sum + (price * item.quantity);
        }, 0);
        
        const taxRate = parseFloat(document.getElementById('manualTax').value) || this.dataManager.data.settings.taxRate || 0;
        const tax = subtotal * (taxRate / 100);
        const total = subtotal + tax;

        const customerSelect = document.getElementById('customerSelect');
        const customerId = customerSelect.value;
        let customer = null;
        let customerName = 'Client invité';
        
        if (customerId === 'CUST_GUEST') {
          customerName = 'Client invité';
        } else if (customerId) {
          customer = this.dataManager.data.customers.find(c => c.id === customerId);
          if (customer) {
            customerName = customer.name;
          }
        }

        const invoiceNumber = Utils.generateInvoiceNumber(this.dataManager.data.sales);
        
        const sale = {
          id: Utils.generateId('SALE_'),
          invoiceNumber: invoiceNumber,
          date: new Date().toISOString(),
          items: this.cart.map(item => {
            const price = this.wholesaleMode && item.wholesalePrice ? item.wholesalePrice : item.price;
            return {
              productId: item.id,
              name: item.name,
              price: price,
              quantity: item.quantity,
              total: price * item.quantity
            };
          }),
          subtotal: subtotal,
          tax: tax,
          total: total,
          customerId: customerId,
          customerName: customerName,
          paymentMethod: paymentMethod,
          status: 'completed',
          userId: this.currentUser.id,
          posId: this.dataManager.data.currentSession.posId
        };

        for (const item of this.cart) {
          const product = this.dataManager.data.products.find(p => p.id === item.id);
          if (product.stock < item.quantity) {
            this.dataManager.showNotification(`Stock insuffisant pour ${product.name}`, 'danger');
            return;
          }
          product.stock -= item.quantity;
          product.salesCount = (product.salesCount || 0) + item.quantity;
          
          const stockMovement = {
            id: Utils.generateId('MVT_'),
            date: new Date().toISOString(),
            productId: product.id,
            productName: product.name,
            type: 'sortie',
            quantity: item.quantity,
            unitPrice: this.wholesaleMode && product.wholesalePrice ? product.wholesalePrice : product.price,
            totalValue: item.quantity * (this.wholesaleMode && product.wholesalePrice ? product.wholesalePrice : product.price),
            reason: `Vente ${invoiceNumber}`,
            createdBy: this.currentUser.id,
            createdAt: new Date().toISOString()
          };
          this.dataManager.data.stockMovements.push(stockMovement);
        }

        this.dataManager.data.sales.push(sale);
        
        if (customer && customerId !== 'CUST_GUEST') {
          customer.totalPurchases = (customer.totalPurchases || 0) + total;
        }
        
        this.dataManager.data.cashRegister.transactions.push({
          id: Utils.generateId('TRX_'),
          date: new Date().toISOString(),
          type: 'sale',
          amount: total,
          description: `Vente ${invoiceNumber} - ${customerName}`,
          userId: this.currentUser.id
        });

        this.dataManager.data.cashRegister.closingBalance += total;

        this.dataManager.data.currentSession.salesCount++;
        this.dataManager.data.currentSession.revenue += total;

        this.dataManager.save();
        
        this.generateReceipt(sale);
        
        this.cart = [];
        this.updateCartDisplay();
        
        document.querySelectorAll('.pos-payment-btn').forEach(b => b.classList.remove('active'));
        
        this.dataManager.showNotification(`Vente enregistrée avec succès ! Facture N°: ${invoiceNumber}`, 'success');
        this.updateStats();
        this.loadAllProducts();
      }

      generateReceipt(sale) {
        const receiptWindow = window.open('', 'receipt', 'width=400,height=700');
        const taxRate = parseFloat(document.getElementById('manualTax').value) || this.dataManager.data.settings.taxRate || 0;
        const showTax = taxRate > 0;
        
        const receiptContent = `
          <!DOCTYPE html>
          <html>
          <head>
            <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+128&display=swap" rel="stylesheet">
            <style>
              body { 
                font-family: 'Courier New', monospace; 
                margin: 0; 
                padding: 20px; 
                font-size: 12px;
              }
              .receipt { 
                max-width: 300px; 
                margin: 0 auto; 
              }
              .header { 
                text-align: center; 
                margin-bottom: 15px; 
              }
              .header h2 { 
                margin: 0; 
                font-size: 16px; 
                font-weight: bold;
              }
              .header p { 
                margin: 3px 0; 
                font-size: 11px; 
              }
              .company-info {
                margin-bottom: 10px;
                padding-bottom: 10px;
                border-bottom: 1px dashed #000;
              }
              .tax-info {
                font-size: 10px;
                margin-bottom: 10px;
                padding-bottom: 5px;
                border-bottom: 1px dashed #000;
              }
              .items { 
                margin: 15px 0; 
              }
              .item { 
                margin-bottom: 8px; 
                font-size: 11px; 
                border-bottom: 1px dotted #ccc;
                padding-bottom: 5px;
              }
              .item-header {
                display: flex;
                justify-content: space-between;
                margin-bottom: 3px;
              }
              .item-name { 
                flex: 3; 
                text-align: left;
                font-weight: bold;
              }
              .item-qty-price {
                flex: 2;
                text-align: right;
                font-size: 10px;
              }
              .item-details {
                font-size: 10px;
                color: #666;
                padding-left: 10px;
              }
              .total { 
                border-top: 2px dashed #000; 
                padding-top: 10px; 
                margin-top: 10px; 
                font-size: 12px;
              }
              .total-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
              }
              .total-in-words {
                margin-top: 10px;
                padding-top: 10px;
                border-top: 1px dashed #000;
                font-style: italic;
                font-size: 11px;
                text-align: center;
              }
              .footer { 
                text-align: center; 
                margin-top: 20px; 
                font-size: 11px; 
              }
              .barcode { 
                text-align: center; 
                margin: 15px 0; 
                font-family: 'Libre Barcode 128', cursive; 
                font-size: 40px; 
              }
              .unit-price {
                font-size: 9px;
                color: #666;
              }
            </style>
          </head>
          <body>
            <div class="receipt">
              <div class="header">
                <h2>${this.dataManager.data.company.name}</h2>
                <div class="company-info">
                  <p>${this.dataManager.data.company.address || ''}</p>
                  <p>Tél: ${this.dataManager.data.company.phone || ''}</p>
                  <p>${new Date().toLocaleString('fr-FR')}</p>
                </div>
                <div class="tax-info">
                  <p><strong>${this.dataManager.data.company.taxId || 'NIF Non spécifié'}</strong></p>
                  <p><strong>${this.dataManager.data.company.statId || 'STAT Non spécifié'}</strong></p>
                </div>
                <div class="barcode">${sale.invoiceNumber || sale.id.replace(/_/g, '')}</div>
                <p><strong>Facture N°: ${sale.invoiceNumber || sale.id}</strong></p>
                <p>Client: ${sale.customerName}</p>
              </div>
              
              <div class="items">
                ${sale.items.map(item => `
                  <div class="item">
                    <div class="item-header">
                      <div class="item-name">${item.name}</div>
                      <div class="item-qty-price">
                        ${item.quantity} x ${Utils.formatCurrency(item.price)}
                      </div>
                    </div>
                    <div class="item-details">
                    </div>
                  </div>
                `).join('')}
              </div>
              
              <div class="total">
                ${showTax ? `
                  <div class="total-row">
                    <span>Sous-total:</span>
                    <span>${Utils.formatCurrency(sale.subtotal)}</span>
                  </div>
                  <div class="total-row">
                    <span>TVA:</span>
                    <span>${Utils.formatCurrency(sale.tax)}</span>
                  </div>
                ` : `
                  <div class="total-row">
                    <span>Total HT:</span>
                    <span>${Utils.formatCurrency(sale.subtotal)}</span>
                  </div>
                  <div class="total-row">
                    <span>TVA:</span>
                    <span>0 Ar</span>
                  </div>
                `}
                <div class="total-row" style="font-weight: bold; font-size: 14px;">
                  <span>TOTAL TTC:</span>
                  <span>${Utils.formatCurrency(sale.total)}</span>
                </div>
              </div>
              
              <div class="total-in-words">
                Arrêté la présente facture à la somme de:<br>
                <strong>${sale.total} Ariary</strong>
              </div>
              
              <div class="footer">
                <p>${this.dataManager.data.settings.receiptHeader}</p>
                <p>Méthode: ${sale.paymentMethod === 'cash' ? 'Espèces' : sale.paymentMethod === 'card' ? 'Carte' : 'Chèque'}</p>
                <p>${this.dataManager.data.settings.receiptFooter}</p>
              </div>
            </div>
          </body>
          </html>
        `;
        
        receiptWindow.document.write(receiptContent);
        receiptWindow.document.close();
        
        setTimeout(() => {
          receiptWindow.print();
        }, 500);
      }

      // === PRODUITS ===
      renderProducts(container) {
        container.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-boxes"></i> Gestion des produits</h3>
              <button class="btn btn-primary" id="addProduct">
                <i class="fas fa-plus"></i> Ajouter un produit
              </button>
            </div>
            
            <div class="form-group">
              <input type="text" id="filterProducts" class="form-control" placeholder="Filtrer les produits...">
            </div>
            
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Code</th>
                    <th>Nom</th>
                    <th>Catégorie</th>
                    <th>Prix en gros</th>
                    <th>Prix</th>
                    <th>Coût</th>
                    <th>Marge</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="productsTable">
                </tbody>
              </table>
            </div>
          </div>
        `;

        this.loadProductsTable();
        this.setupProductsEventListeners();
      }

      setupProductsEventListeners() {
        document.getElementById('addProduct').addEventListener('click', () => {
          this.showProductModal();
        });

        document.getElementById('filterProducts').addEventListener('input', (e) => {
          this.filterProductsTable(e.target.value);
        });
      }

      loadProductsTable() {
        const tbody = document.getElementById('productsTable');
        const products = this.dataManager.data.products;
        
        tbody.innerHTML = products.map(product => {
          const margin = ((product.price - product.cost) / product.price * 100).toFixed(1);
          
          return `
            <tr>
              <td>${product.barcode || product.id.substring(0, 8)}</td>
              <td><strong>${product.name}</strong></td>
              <td>${product.category || 'Non catégorisé'}</td>
              <td>${product.wholesalePrice ? Utils.formatCurrency(product.wholesalePrice) : '-'}</td>
              <td>${Utils.formatCurrency(product.price)}</td>
              <td>${Utils.formatCurrency(product.cost)}</td>
              <td>${margin}%</td>
              <td>
                <div class="d-flex gap-10">
                  <button class="btn btn-sm btn-outline" onclick="app.editProduct('${product.id}')">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="app.deleteProduct('${product.id}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }

      filterProductsTable(query) {
        const tbody = document.getElementById('productsTable');
        const products = this.dataManager.data.products;
        
        if (!query.trim()) {
          this.loadProductsTable();
          return;
        }
        
        const filtered = products.filter(product =>
          product.name.toLowerCase().includes(query.toLowerCase()) ||
          (product.barcode && product.barcode.includes(query)) ||
          (product.category && product.category.toLowerCase().includes(query.toLowerCase()))
        );
        
        tbody.innerHTML = filtered.map(product => {
          const margin = ((product.price - product.cost) / product.price * 100).toFixed(1);
          
          return `
            <tr>
              <td>${product.barcode || product.id.substring(0, 8)}</td>
              <td><strong>${product.name}</strong></td>
              <td>${product.category || 'Non catégorisé'}</td>
              <td>${product.wholesalePrice ? Utils.formatCurrency(product.wholesalePrice) : '-'}</td>
              <td>${Utils.formatCurrency(product.price)}</td>
              <td>${Utils.formatCurrency(product.cost)}</td>
              <td>${margin}%</td>
              <td>
                <div class="d-flex gap-10">
                  <button class="btn btn-sm btn-outline" onclick="app.editProduct('${product.id}')">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="app.deleteProduct('${product.id}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }

      showProductModal(product = null) {
        const isEdit = !!product;
        const modal = document.getElementById('genericModal');
        
        modal.querySelector('#modalTitle').textContent = isEdit ? 'Modifier le produit' : 'Nouveau produit';
        
        modal.querySelector('#modalBody').innerHTML = `
          <div class="form-group">
            <label class="form-label">Nom du produit *</label>
            <input type="text" id="productName" class="form-control" value="${product ? product.name : ''}" required>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Catégorie</label>
              <input type="text" id="productCategory" class="form-control" value="${product ? product.category : ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Code barre</label>
              <input type="text" id="productBarcode" class="form-control" value="${product ? product.barcode || '' : ''}">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Prix en gros</label>
              <input type="number" id="productWholesalePrice" class="form-control" 
                     value="${product ? product.wholesalePrice || '' : ''}" min="0" step="0.01">
            </div>
            <div class="form-group">
              <label class="form-label">Prix de vente *</label>
              <input type="number" id="productPrice" class="form-control" 
                     value="${product ? product.price : ''}" required min="0" step="0.01">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Coût d'achat</label>
              <input type="number" id="productCost" class="form-control" 
                     value="${product ? product.cost : ''}" min="0" step="0.01">
            </div>
            <div class="form-group">
              <label class="form-label">Stock initial *</label>
              <input type="number" id="productStock" class="form-control" 
                     value="${product ? product.stock : '0'}" required min="0">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea id="productDescription" class="form-control" rows="3">${product ? product.description || '' : ''}</textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">Fournisseur</label>
            <select id="productSupplier" class="form-control">
              <option value="">-- Sélectionner --</option>
              ${this.dataManager.data.suppliers.map(s => `
                <option value="${s.id}" ${product && product.supplierId === s.id ? 'selected' : ''}>${s.name}</option>
              `).join('')}
            </select>
          </div>
        `;
        
        modal.querySelector('#modalFooter').innerHTML = `
          <button class="btn btn-primary" id="modalConfirm">
            ${isEdit ? 'Modifier' : 'Ajouter'}
          </button>
        `;
        
        modal.classList.add('active');
        
        modal.querySelector('#modalConfirm').onclick = () => {
          const productData = {
            name: document.getElementById('productName').value.trim(),
            category: document.getElementById('productCategory').value.trim(),
            barcode: document.getElementById('productBarcode').value.trim(),
            wholesalePrice: parseFloat(document.getElementById('productWholesalePrice').value) || null,
            price: parseFloat(document.getElementById('productPrice').value),
            cost: parseFloat(document.getElementById('productCost').value) || 0,
            stock: parseInt(document.getElementById('productStock').value),
            description: document.getElementById('productDescription').value.trim(),
            supplierId: document.getElementById('productSupplier').value
          };
          
          if (!productData.name || isNaN(productData.price) || isNaN(productData.stock)) {
            this.dataManager.showNotification('Veuillez remplir les champs obligatoires', 'danger');
            return;
          }
          
          if (isEdit) {
            Object.assign(product, productData);
            this.dataManager.showNotification('Produit modifié avec succès', 'success');
          } else {
            productData.id = Utils.generateId('PROD_');
            productData.createdAt = new Date().toISOString();
            productData.salesCount = 0;
            this.dataManager.data.products.push(productData);
            this.dataManager.showNotification('Produit ajouté avec succès', 'success');
          }
          
          this.dataManager.save();
          this.loadProductsTable();
          this.closeModal();
        };
      }

      editProduct(productId) {
        const product = this.dataManager.data.products.find(p => p.id === productId);
        if (product) {
          this.showProductModal(product);
        }
      }

      deleteProduct(productId) {
        if (confirm('Êtes-vous sûr de vouloir supprimer ce produit ?')) {
          const index = this.dataManager.data.products.findIndex(p => p.id === productId);
          if (index !== -1) {
            this.dataManager.data.products.splice(index, 1);
            this.dataManager.save();
            this.loadProductsTable();
            this.dataManager.showNotification('Produit supprimé avec succès', 'success');
          }
        }
      }

      // === DASHBOARD, STOCK, INVENTORY, CUSTOMERS, SUPPLIERS, FILTER, CASH, CASHDETAILS, SETTINGS ===
      // Ces méthodes doivent également être incluses mais je les ai omises par souci de concision
      // Elles contiennent le code pour afficher les autres pages de l'application

      renderDashboard(container) {
        const stats = this.getDashboardStats();
        
        container.innerHTML = `
          <div class="grid grid-4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title"><i class="fas fa-chart-line"></i> Ventes du jour</h3>
              </div>
              <div class="text-center">
                <h2 style="font-size: 2.5rem; color: var(--success);">${Utils.formatCurrency(stats.todayRevenue)}</h2>
                <p class="text-muted">${stats.todaySales} transactions</p>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h3 class="card-title"><i class="fas fa-boxes"></i> Stock</h3>
              </div>
              <div class="text-center">
                <h2 style="font-size: 2.5rem; color: var(--warning);">${stats.totalArticles}</h2>
                <p class="text-muted">${stats.totalProducts} produits</p>
                <p class="text-muted">Valeur: ${Utils.formatCurrency(stats.stockValue)}</p>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h3 class="card-title"><i class="fas fa-cash-register"></i> Caisse</h3>
              </div>
              <div class="text-center">
                <h2 style="font-size: 2.5rem; color: var(--info);">${Utils.formatCurrency(stats.cashBalance)}</h2>
                <p class="text-muted">Solde restant</p>
                <p class="text-muted">Initial: ${Utils.formatCurrency(stats.openingBalance)}</p>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h3 class="card-title"><i class="fas fa-users"></i> Clients</h3>
              </div>
              <div class="text-center">
                <h2 style="font-size: 2.5rem; color: var(--primary);">${stats.totalCustomers}</h2>
                <p class="text-muted">Ce mois</p>
                <p class="text-muted">CA: ${Utils.formatCurrency(stats.monthRevenue)}</p>
              </div>
            </div>
          </div>
        `;
      }

      getDashboardStats() {
        const today = new Date().toISOString().split('T')[0];
        const todaySales = this.dataManager.data.sales.filter(s => s.date.startsWith(today));
        const todayRevenue = todaySales.reduce((sum, s) => sum + s.total, 0);
        const totalProducts = this.dataManager.data.products.length;
        const totalArticles = this.dataManager.data.products.reduce((sum, p) => sum + p.stock, 0);
        const stockValue = this.dataManager.data.products.reduce((sum, p) => sum + (p.stock * (p.cost || 0)), 0);
        const cashBalance = this.dataManager.data.cashRegister.closingBalance;
        const openingBalance = this.dataManager.data.cashRegister.openingBalance;
        const totalCustomers = this.dataManager.data.customers.length;
        
        const now = new Date();
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        const monthSales = this.dataManager.data.sales.filter(s => s.date >= monthStart);
        const monthRevenue = monthSales.reduce((sum, s) => sum + s.total, 0);

        return {
          todaySales: todaySales.length,
          todayRevenue: todayRevenue,
          totalProducts: totalProducts,
          totalArticles: totalArticles,
          stockValue: stockValue,
          cashBalance: cashBalance,
          openingBalance: openingBalance,
          totalCustomers: totalCustomers,
          monthRevenue: monthRevenue
        };
      }

      // === PARAMÈTRES ===
      renderSettings(container) {
        container.innerHTML = `
          <div class="import-export-buttons">
            <button class="btn btn-success" id="importBackup">
              <i class="fas fa-file-import"></i> Importer
            </button>
            <button class="btn btn-primary" id="exportBackup">
              <i class="fas fa-file-export"></i> Exporter tout
            </button>
            <button class="btn btn-warning" id="resetData">
              <i class="fas fa-redo"></i> Réinitialiser données
            </button>
          </div>
          
          <div class="grid grid-2">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title"><i class="fas fa-building"></i> Informations de l'entreprise</h3>
              </div>
              <div class="form-group">
                <label class="form-label">Nom de l'entreprise *</label>
                <input type="text" id="companyName" class="form-control" value="${this.dataManager.data.company.name}">
              </div>
              <div class="form-group">
                <label class="form-label">Adresse</label>
                <textarea id="companyAddress" class="form-control" rows="3">${this.dataManager.data.company.address || ''}</textarea>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Téléphone</label>
                  <input type="tel" id="companyPhone" class="form-control" value="${this.dataManager.data.company.phone || ''}">
                </div>
                <div class="form-group">
                  <label class="form-label">Email</label>
                  <input type="email" id="companyEmail" class="form-control" value="${this.dataManager.data.company.email || ''}">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">NIF/Numéro fiscal</label>
                  <input type="text" id="companyTaxId" class="form-control" value="${this.dataManager.data.company.taxId || ''}">
                </div>
                <div class="form-group">
                  <label class="form-label">STAT/Registre</label>
                  <input type="text" id="companyStatId" class="form-control" value="${this.dataManager.data.company.statId || ''}">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Taux de TVA (%)</label>
                  <input type="number" id="taxRate" class="form-control" value="${this.dataManager.data.settings.taxRate}" min="0" max="100" step="0.1">
                </div>
              </div>
              <button class="btn btn-primary w-100" id="saveSettings">
                <i class="fas fa-save"></i> Enregistrer les paramètres
              </button>
            </div>

            <div class="card">
              <div class="card-header">
                <h3 class="card-title"><i class="fas fa-cog"></i> Configuration système</h3>
              </div>
              <div class="form-group">
                <label class="form-label">
                  <input type="checkbox" id="autoBackup" ${this.dataManager.data.settings.autoBackup ? 'checked' : ''}>
                  Sauvegarde automatique
                </label>
              </div>
              <div class="form-group">
                <label class="form-label">
                  <input type="checkbox" id="barcodeEnabled" ${this.dataManager.data.settings.barcodeEnabled ? 'checked' : ''}>
                  Activation du scan de codes-barres
                </label>
              </div>
              <div class="form-group">
                <label class="form-label">Entête des tickets</label>
                <textarea id="receiptHeader" class="form-control" rows="2">${this.dataManager.data.settings.receiptHeader}</textarea>
              </div>
              <div class="form-group">
                <label class="form-label">Pied des tickets</label>
                <textarea id="receiptFooter" class="form-control" rows="2">${this.dataManager.data.settings.receiptFooter}</textarea>
              </div>
              <div class="form-group">
                <label class="form-label">Devise</label>
                <input type="text" id="currency" class="form-control" value="${this.dataManager.data.settings.currency}">
              </div>
            </div>
          </div>
        `;

        this.setupSettingsEventListeners();
      }

      setupSettingsEventListeners() {
        document.getElementById('saveSettings').addEventListener('click', () => {
          this.saveSettings();
        });

        document.getElementById('importBackup').addEventListener('click', () => {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          input.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
              this.dataManager.importBackup(file);
            }
          };
          input.click();
        });

        document.getElementById('exportBackup').addEventListener('click', () => {
          this.dataManager.exportAllData();
        });

        document.getElementById('resetData').addEventListener('click', () => {
          if (confirm('Êtes-vous sûr de vouloir réinitialiser toutes les données ? Cette action est irréversible.')) {
            localStorage.removeItem(this.dataManager.storageKey);
            localStorage.removeItem('shop_miharisoa_session');
            location.reload();
          }
        });
      }

      saveSettings() {
        this.dataManager.data.company.name = document.getElementById('companyName').value;
        this.dataManager.data.company.address = document.getElementById('companyAddress').value;
        this.dataManager.data.company.phone = document.getElementById('companyPhone').value;
        this.dataManager.data.company.email = document.getElementById('companyEmail').value;
        this.dataManager.data.company.taxId = document.getElementById('companyTaxId').value;
        this.dataManager.data.company.statId = document.getElementById('companyStatId').value;
        
        this.dataManager.data.settings.taxRate = parseFloat(document.getElementById('taxRate').value);
        this.dataManager.data.settings.autoBackup = document.getElementById('autoBackup').checked;
        this.dataManager.data.settings.barcodeEnabled = document.getElementById('barcodeEnabled').checked;
        this.dataManager.data.settings.receiptHeader = document.getElementById('receiptHeader').value;
        this.dataManager.data.settings.receiptFooter = document.getElementById('receiptFooter').value;
        this.dataManager.data.settings.currency = document.getElementById('currency').value;
        
        this.dataManager.save();
        this.updateUserInfo();
        this.dataManager.showNotification('Paramètres sauvegardés avec succès', 'success');
      }

      // === UTILITAIRES ===
      getUserName(userId) {
        const user = this.dataManager.data.users.find(u => u.id === userId);
        return user ? user.name : 'Inconnu';
      }
// === FILTRE ===
      renderFilter(container) {
        const currentYear = new Date().getFullYear();
        const years = Array.from({length: 10}, (_, i) => currentYear + i);
        
        container.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-filter"></i> Filtre des actions</h3>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Année</label>
                <select id="filterYear" class="form-control">
                  <option value="">Toutes</option>
                  ${years.map(year => `<option value="${year}">${year}</option>`).join('')}
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Mois</label>
                <select id="filterMonth" class="form-control">
                  <option value="">Tous</option>
                  <option value="1">Janvier</option>
                  <option value="2">Février</option>
                  <option value="3">Mars</option>
                  <option value="4">Avril</option>
                  <option value="5">Mai</option>
                  <option value="6">Juin</option>
                  <option value="7">Juillet</option>
                  <option value="8">Août</option>
                  <option value="9">Septembre</option>
                  <option value="10">Octobre</option>
                  <option value="11">Novembre</option>
                  <option value="12">Décembre</option>
                </select>
              </div>
            </div>
            
            <button class="btn btn-primary" id="applyFilter">
              <i class="fas fa-check"></i> Appliquer
            </button>
            
            <div class="filter-results-container" id="filterResults">
              <div class="alert alert-info">
                Sélectionnez des critères de filtrage et cliquez sur "Appliquer"
              </div>
            </div>
            
            <div class="chart-container">
              <canvas id="revenueChart"></canvas>
            </div>
          </div>
        `;
        
        document.getElementById('applyFilter').addEventListener('click', () => {
          this.applyFilter();
        });
      }

      applyFilter() {
        const year = document.getElementById('filterYear').value;
        const month = document.getElementById('filterMonth').value;
        
        let results = '';
        
        // Tableau de bord 12 mois
        const now = new Date();
        const currentYear = now.getFullYear();
        const selectedYear = year ? parseInt(year) : currentYear;
        const monthlyData = [];
        
        for (let i = 1; i <= 12; i++) {
          if (month && parseInt(month) !== i) continue;
          
          const monthSales = this.dataManager.data.sales.filter(sale => {
            const saleDate = new Date(sale.date);
            return saleDate.getFullYear() === selectedYear && saleDate.getMonth() + 1 === i;
          });
          
          const monthRevenue = monthSales.reduce((sum, sale) => sum + sale.total, 0);
          const monthCost = monthSales.reduce((sum, sale) => {
            const cost = sale.items.reduce((itemSum, item) => {
              const product = this.dataManager.data.products.find(p => p.id === item.productId);
              return itemSum + (item.quantity * (product ? product.cost : 0));
            }, 0);
            return sum + cost;
          }, 0);
          
          const monthOPEX = this.dataManager.data.opex.filter(opex => {
            const opexDate = new Date(opex.date);
            return opexDate.getFullYear() === selectedYear && opexDate.getMonth() + 1 === i;
          }).reduce((sum, opex) => sum + opex.amount, 0);
          
          const grossMargin = monthRevenue - monthCost;
          const netMargin = grossMargin - monthOPEX;
          
          monthlyData.push({
            month: i,
            year: selectedYear,
            sales: monthSales.length,
            revenue: monthRevenue,
            cost: monthCost,
            grossMargin: grossMargin,
            opex: monthOPEX,
            netMargin: netMargin
          });
        }
        
        // Calculer les totaux
        const totalRevenue = monthlyData.reduce((sum, data) => sum + data.revenue, 0);
        const totalCost = monthlyData.reduce((sum, data) => sum + data.cost, 0);
        const totalGrossMargin = monthlyData.reduce((sum, data) => sum + data.grossMargin, 0);
        const totalOPEX = monthlyData.reduce((sum, data) => sum + data.opex, 0);
        const totalNetMargin = monthlyData.reduce((sum, data) => sum + data.netMargin, 0);
        
        results += `
          <h4>Analyse financière ${selectedYear}${month ? ` - Mois ${month}` : ''}</h4>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Mois</th>
                  <th>Chiffre d'affaires</th>
                  <th>Coût</th>
                  <th>Marge brute</th>
                  <th>OPEX</th>
                  <th>Marge nette</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        monthlyData.forEach(data => {
          const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
          results += `
            <tr>
              <td>${monthNames[data.month - 1]}</td>
              <td>${Utils.formatCurrency(data.revenue)}</td>
              <td>${Utils.formatCurrency(data.cost)}</td>
              <td class="${data.grossMargin >= 0 ? 'text-success' : 'text-danger'}">${Utils.formatCurrency(data.grossMargin)}</td>
              <td>${Utils.formatCurrency(data.opex)}</td>
              <td class="${data.netMargin >= 0 ? 'text-success' : 'text-danger'}">${Utils.formatCurrency(data.netMargin)}</td>
            </tr>
          `;
        });
        
        results += `
                <tr style="font-weight: bold; background: var(--bg);">
                  <td>TOTAL</td>
                  <td>${Utils.formatCurrency(totalRevenue)}</td>
                  <td>${Utils.formatCurrency(totalCost)}</td>
                  <td class="${totalGrossMargin >= 0 ? 'text-success' : 'text-danger'}">${Utils.formatCurrency(totalGrossMargin)}</td>
                  <td>${Utils.formatCurrency(totalOPEX)}</td>
                  <td class="${totalNetMargin >= 0 ? 'text-success' : 'text-danger'}">${Utils.formatCurrency(totalNetMargin)}</td>
                </tr>
              </tbody>
            </table>
          </div>
        `;
        
        document.getElementById('filterResults').innerHTML = results;
        
        // Créer le graphique
        this.createRevenueChart(monthlyData, selectedYear);
      }

      createRevenueChart(monthlyData, year) {
        const canvas = document.getElementById('revenueChart');
        const ctx = canvas.getContext('2d');
        
        // Redimensionner le canvas
        canvas.width = canvas.parentElement.offsetWidth;
        canvas.height = 300;
        
        // Données pour le graphique
        const months = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'];
        const revenues = monthlyData.map(data => data.revenue);
        const costs = monthlyData.map(data => data.cost);
        const netMargins = monthlyData.map(data => data.netMargin);
        
        // Trouver le maximum pour l'échelle
        const maxValue = Math.max(...revenues, ...costs, ...netMargins.map(m => Math.abs(m)));
        
        // Effacer le canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Configurations
        const padding = 40;
        const chartWidth = canvas.width - padding * 2;
        const chartHeight = canvas.height - padding * 2;
        
        // Dessiner l'axe Y
        ctx.beginPath();
        ctx.moveTo(padding, padding);
        ctx.lineTo(padding, canvas.height - padding);
        ctx.strokeStyle = '#333';
        ctx.stroke();
        
        // Dessiner l'axe X
        ctx.beginPath();
        ctx.moveTo(padding, canvas.height - padding);
        ctx.lineTo(canvas.width - padding, canvas.height - padding);
        ctx.strokeStyle = '#333';
        ctx.stroke();
        
        // Échelle Y
        const ySteps = 5;
        const yStepValue = maxValue / ySteps;
        
        for (let i = 0; i <= ySteps; i++) {
          const y = canvas.height - padding - (chartHeight / ySteps) * i;
          const value = Math.round(yStepValue * i);
          
          ctx.fillStyle = '#666';
          ctx.font = '12px Arial';
          ctx.textAlign = 'right';
          ctx.fillText(Utils.formatCurrency(value), padding - 5, y + 3);
          
          ctx.beginPath();
          ctx.moveTo(padding - 5, y);
          ctx.lineTo(padding, y);
          ctx.strokeStyle = '#ddd';
          ctx.stroke();
        }
        
        // Largeur de barre
        const barWidth = (chartWidth / monthlyData.length) * 0.6;
        const barSpacing = (chartWidth / monthlyData.length) * 0.4;
        
        // Dessiner les barres
        monthlyData.forEach((data, index) => {
          const x = padding + (index * (barWidth + barSpacing)) + barSpacing / 2;
          
          // Barre du chiffre d'affaires (bleu)
          const revenueHeight = (data.revenue / maxValue) * chartHeight;
          const revenueY = canvas.height - padding - revenueHeight;
          
          ctx.fillStyle = '#3498db';
          ctx.fillRect(x, revenueY, barWidth, revenueHeight);
          
          // Barre du coût (rouge)
          const costHeight = (data.cost / maxValue) * chartHeight;
          const costY = canvas.height - padding - costHeight;
          
          ctx.fillStyle = '#e74c3c';
          ctx.fillRect(x + barWidth, costY, barWidth / 2, costHeight);
          
          // Ligne de marge nette (verte)
          const marginHeight = (Math.abs(data.netMargin) / maxValue) * chartHeight;
          const marginY = data.netMargin >= 0 ? 
            canvas.height - padding - marginHeight : 
            canvas.height - padding;
          
          ctx.beginPath();
          ctx.moveTo(x + barWidth / 2, marginY);
          ctx.lineTo(x + barWidth * 1.5, marginY);
          ctx.strokeStyle = data.netMargin >= 0 ? '#27ae60' : '#f39c12';
          ctx.lineWidth = 2;
          ctx.stroke();
          
          // Nom du mois
          ctx.fillStyle = '#333';
          ctx.font = '12px Arial';
          ctx.textAlign = 'center';
          ctx.fillText(months[data.month - 1], x + barWidth, canvas.height - padding + 15);
        });
        
        // Légende
        const legendItems = [
          { color: '#3498db', label: 'Chiffre d\'affaires' },
          { color: '#e74c3c', label: 'Coût' },
          { color: '#27ae60', label: 'Marge nette positive' },
          { color: '#f39c12', label: 'Marge nette négative' }
        ];
        
        legendItems.forEach((item, index) => {
          const legendX = padding + (index * 150);
          const legendY = 20;
          
          ctx.fillStyle = item.color;
          ctx.fillRect(legendX, legendY, 15, 15);
          
          ctx.fillStyle = '#333';
          ctx.font = '12px Arial';
          ctx.textAlign = 'left';
          ctx.fillText(item.label, legendX + 20, legendY + 12);
        });
        
        // Titre
        ctx.fillStyle = '#333';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(`Évolution du chiffre d'affaires ${year}`, canvas.width / 2, 20);
      }
// === CAISSE ===
renderCash(container) {
  const today = new Date().toISOString().split('T')[0];
  
  container.innerHTML = `
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-money-bill-wave"></i> Gestion de caisse</h3>
      </div>
      
      <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> 
        Cet onglet affiche toutes les ventes avec leur numéro de facture, ainsi que toutes les OPEX et charges, y compris les approvisionnements.
      </div>
      
      <div class="grid grid-3">
        <div class="card">
          <div class="card-header">
            <h4 class="card-title"><i class="fas fa-cash-register"></i> État de caisse</h4>
          </div>
          <div class="text-center">
            <h2 style="font-size: 2.5rem; color: var(--success);">${Utils.formatCurrency(this.dataManager.data.cashRegister.closingBalance)}</h2>
            <p class="text-muted">Solde restant</p>
            <p class="text-muted">Solde initial: ${Utils.formatCurrency(this.dataManager.data.cashRegister.openingBalance)}</p>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h4 class="card-title"><i class="fas fa-shopping-cart"></i> Ventes aujourd'hui</h4>
          </div>
          <div class="text-center">
            <h2 style="font-size: 2.5rem; color: var(--primary);">${Utils.formatCurrency(this.dataManager.data.currentSession.revenue || 0)}</h2>
            <p class="text-muted">${this.dataManager.data.currentSession.salesCount || 0} transactions</p>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h4 class="card-title"><i class="fas fa-chart-pie"></i> Dépenses du mois</h4>
          </div>
          <div class="text-center">
            <h2 style="font-size: 2.5rem; color: var(--danger);">${Utils.formatCurrency(this.getMonthlyExpenses())}</h2>
            <p class="text-muted">OPEX & Charges</p>
          </div>
        </div>
      </div>
      
      <div class="card mt-20">
        <div class="card-header">
          <h4 class="card-title"><i class="fas fa-list"></i> Transactions complètes</h4>
        </div>
        
        <div class="date-filter">
          <div class="form-group">
            <label class="form-label">Date début</label>
            <input type="date" id="cashStartDate" class="form-control" value="${today}">
          </div>
          <div class="form-group">
            <label class="form-label">Date fin</label>
            <input type="date" id="cashEndDate" class="form-control" value="${today}">
          </div>
          <div class="form-group">
            <label class="form-label">Type</label>
            <select id="cashFilterType" class="form-control">
              <option value="">Toutes les transactions</option>
              <option value="sale">Ventes</option>
              <option value="expense">Dépenses</option>
              <option value="opex">OPEX</option>
              <option value="purchase">Approvisionnements</option>
              <option value="deposit">Dépôts</option>
              <option value="withdrawal">Retraits</option>
            </select>
          </div>
          <div class="d-flex gap-10">
            <button class="btn btn-primary" id="applyCashFilter">
              <i class="fas fa-check"></i> Appliquer
            </button>
            <button class="btn btn-outline" id="resetCashFilter">
              <i class="fas fa-redo"></i> Réinitialiser
            </button>
          </div>
        </div>
        
        <div class="table-responsive mt-20">
          <table class="table">
            <thead>
              <tr>
                <th>Date/Heure</th>
                <th>Type</th>
                <th>Description / N° Facture</th>
                <th>Client / Catégorie</th>
                <th>Montant</th>
                <th>Solde après</th>
              </tr>
            </thead>
            <tbody id="cashTransactions">
            </tbody>
          </table>
        </div>
        
        <div class="text-right mt-10">
          <strong>Solde final: </strong>
          <span id="cashFinalBalance" style="color: var(--success); font-size: 1.2rem;">${Utils.formatCurrency(this.dataManager.data.cashRegister.closingBalance)}</span>
        </div>
      </div>
    </div>
  `;
  
  this.setupCashEventListeners();
  this.loadCashTransactions();
}

getMonthlyExpenses() {
  const now = new Date();
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
  const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
  
  const monthlyOPEX = this.dataManager.data.opex.filter(op => 
    op.date >= monthStart && op.date <= monthEnd
  );
  
  const monthlyExpenses = this.dataManager.data.expenses.filter(exp => 
    exp.date >= monthStart && exp.date <= monthEnd && exp.type !== 'opex'
  );
  
  const monthlyPurchases = this.dataManager.data.purchases.filter(p => {
    const purchaseDate = new Date(p.date).toISOString().split('T')[0];
    return purchaseDate >= monthStart && purchaseDate <= monthEnd;
  });
  
  const totalOPEX = monthlyOPEX.reduce((sum, op) => sum + op.amount, 0);
  const totalExpenses = monthlyExpenses.reduce((sum, exp) => sum + exp.amount, 0);
  const totalPurchases = monthlyPurchases.reduce((sum, p) => sum + p.total, 0);
  
  return totalOPEX + totalExpenses + totalPurchases;
}

setupCashEventListeners() {
  document.getElementById('applyCashFilter').addEventListener('click', () => {
    this.loadCashTransactions();
  });

  document.getElementById('resetCashFilter').addEventListener('click', () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('cashStartDate').value = today;
    document.getElementById('cashEndDate').value = today;
    document.getElementById('cashFilterType').value = '';
    this.loadCashTransactions();
  });
}

loadCashTransactions() {
  const tbody = document.getElementById('cashTransactions');
  const startDate = document.getElementById('cashStartDate').value;
  const endDate = document.getElementById('cashEndDate').value;
  const filterType = document.getElementById('cashFilterType').value;
  
  // Récupérer toutes les transactions SANS DOUBLONS
  let allTransactions = [];
  
  // Ajouter les ventes
  this.dataManager.data.sales.forEach(sale => {
    allTransactions.push({
      id: sale.id,
      date: sale.date,
      type: 'sale',
      description: `Vente ${sale.invoiceNumber || sale.id}`,
      detail: sale.customerName,
      amount: sale.total,
      balance: 0
    });
  });
  
  // Ajouter les OPEX uniquement depuis data.opex
  this.dataManager.data.opex.forEach(opex => {
    allTransactions.push({
      id: opex.id,
      date: opex.date,
      type: 'opex',
      description: `OPEX: ${opex.description}`,
      detail: opex.category,
      amount: -opex.amount,
      balance: 0
    });
  });
  
  // Ajouter les autres dépenses (sauf OPEX et purchases)
  this.dataManager.data.expenses.forEach(exp => {
    // Exclure les OPEX (déjà traités) et les purchases (traités séparément)
    if (exp.type !== 'opex' && exp.type !== 'purchase') {
      allTransactions.push({
        id: exp.id,
        date: exp.date,
        type: 'expense',
        description: `Dépense: ${exp.description}`,
        detail: exp.category || 'Général',
        amount: -exp.amount,
        balance: 0
      });
    }
  });
  
  // Ajouter les approvisionnements uniquement depuis purchases
  this.dataManager.data.purchases.forEach(purchase => {
    allTransactions.push({
      id: purchase.id,
      date: purchase.date,
      type: 'purchase',
      description: `Approvisionnement - ${purchase.supplierName}`,
      detail: 'Achat marchandises',
      amount: -purchase.total,
      balance: 0
    });
  });
  
  // Ajouter les opérations de caisse
  this.dataManager.data.cashOperations.forEach(op => {
    allTransactions.push({
      id: op.id,
      date: op.date,
      type: op.type === 'entree' ? 'deposit' : 'withdrawal',
      description: op.description,
      detail: 'Opération caisse',
      amount: op.type === 'entree' ? op.amount : -op.amount,
      balance: op.newBalance
    });
  });
  
  // Filtrer par date
  if (startDate && endDate) {
    allTransactions = allTransactions.filter(t => {
      const tDate = t.date.split('T')[0];
      return tDate >= startDate && tDate <= endDate;
    });
  }
  
  // Filtrer par type
  if (filterType) {
    if (filterType === 'sale') {
      allTransactions = allTransactions.filter(t => t.type === 'sale');
    } else if (filterType === 'expense' || filterType === 'opex' || filterType === 'purchase') {
      allTransactions = allTransactions.filter(t => t.type === filterType);
    } else if (filterType === 'deposit') {
      allTransactions = allTransactions.filter(t => t.type === 'deposit');
    } else if (filterType === 'withdrawal') {
      allTransactions = allTransactions.filter(t => t.type === 'withdrawal');
    }
  }
  
  // Trier par date (plus récent en premier)
  allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  if (allTransactions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">Aucune transaction trouvée</td></tr>';
    return;
  }
  
  let html = '';
  let runningBalance = this.dataManager.data.cashRegister.closingBalance;
  
  allTransactions.forEach(transaction => {
    // Ajuster le solde pour les transactions passées
    if (new Date(transaction.date) < new Date()) {
      runningBalance -= transaction.amount;
    }
    
    const typeBadge = transaction.type === 'sale' ? 'badge-success' :
                     transaction.type === 'opex' ? 'badge-danger' :
                     transaction.type === 'expense' ? 'badge-warning' :
                     transaction.type === 'purchase' ? 'badge-info' :
                     transaction.type === 'deposit' ? 'badge-primary' : 'badge-secondary';
    
    const typeLabel = transaction.type === 'sale' ? 'Vente' :
                     transaction.type === 'opex' ? 'OPEX' :
                     transaction.type === 'expense' ? 'Dépense' :
                     transaction.type === 'purchase' ? 'Approvisionnement' :
                     transaction.type === 'deposit' ? 'Dépôt' : 'Retrait';
    
    html += `
      <tr>
        <td>${Utils.formatDateTime(transaction.date)}</td>
        <td>
          <span class="badge ${typeBadge}">${typeLabel}</span>
        </td>
        <td>${transaction.description}</td>
        <td>${transaction.detail}</td>
        <td class="${transaction.amount >= 0 ? 'text-success' : 'text-danger'}">
          ${transaction.amount >= 0 ? '+' : ''}${Utils.formatCurrency(transaction.amount)}
        </td>
        <td>${Utils.formatCurrency(transaction.balance || runningBalance)}</td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}
// === CONFIGURATION CAISSE ===
      renderCashConfig(container) {
        container.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-cash-register"></i> Configuration de la Caisse</h3>
            </div>
            
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> 
              Configurez les paramètres de base de votre caisse. Les modifications seront appliquées immédiatement.
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Solde initial</label>
                <input type="number" id="cashOpeningBalance" class="form-control" 
                       value="${this.dataManager.data.cashRegister.openingBalance}" min="0">
                <small class="text-muted">Le solde avec lequel vous commencez chaque jour</small>
              </div>
              <div class="form-group">
                <label class="form-label">Solde actuel</label>
                <input type="text" id="cashCurrentBalance" class="form-control" 
                       value="${Utils.formatCurrency(this.dataManager.data.cashRegister.closingBalance)}" readonly>
                <small class="text-muted">Solde calculé automatiquement</small>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Date de dernière fermeture</label>
                <input type="text" class="form-control" 
                       value="${this.dataManager.data.cashRegister.lastClosed ? Utils.formatDateTime(this.dataManager.data.cashRegister.lastClosed) : 'Jamais'}" 
                       readonly>
              </div>
              <div class="form-group">
                <label class="form-label">Nombre de transactions</label>
                <input type="text" class="form-control" 
                       value="${this.dataManager.data.cashRegister.transactions.length}" 
                       readonly>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Raison du changement</label>
              <input type="text" id="cashChangeReason" class="form-control" 
                     placeholder="Ex: Ajustement quotidien, Correction d'erreur...">
            </div>
            
            <div class="d-flex gap-10">
              <button class="btn btn-primary" id="saveCashConfig">
                <i class="fas fa-save"></i> Mettre à jour le solde
              </button>
              <button class="btn btn-warning" id="resetCashToOpening">
                <i class="fas fa-undo"></i> Réinitialiser au solde initial
              </button>
              <button class="btn btn-danger" id="closeCashRegister">
                <i class="fas fa-lock"></i> Fermer la caisse
              </button>
            </div>
            
            <div class="alert alert-warning mt-20">
              <i class="fas fa-exclamation-triangle"></i>
              <strong>Attention :</strong> Toute modification du solde initial affectera également le solde actuel.
              Assurez-vous d'avoir une raison valable et documentée pour chaque ajustement.
            </div>
          </div>
        `;
        
        this.setupCashConfigEventListeners(container);
      }

      setupCashConfigEventListeners(container) {
        // Sauvegarder la configuration
        container.querySelector('#saveCashConfig').addEventListener('click', () => {
          this.saveCashConfig();
        });
        
        // Réinitialiser au solde initial
        container.querySelector('#resetCashToOpening').addEventListener('click', () => {
          this.resetCashToOpening();
        });
        
        // Fermer la caisse
        container.querySelector('#closeCashRegister').addEventListener('click', () => {
          this.closeCashRegister();
        });
      }

      saveCashConfig() {
        const newOpening = parseFloat(document.getElementById('cashOpeningBalance').value);
        const reason = document.getElementById('cashChangeReason').value.trim();
        
        if (isNaN(newOpening) || newOpening < 0) {
          this.dataManager.showNotification('Veuillez entrer un montant valide pour le solde initial', 'danger');
          return;
        }
        
        if (!reason) {
          this.dataManager.showNotification('Veuillez indiquer la raison du changement', 'warning');
          return;
        }
        
        const oldOpening = this.dataManager.data.cashRegister.openingBalance;
        const difference = newOpening - oldOpening;
        
        // Demander confirmation pour les changements importants
        if (Math.abs(difference) > 100000) {
          if (!confirm(`Vous êtes sur le point de modifier le solde initial de ${Utils.formatCurrency(oldOpening)} à ${Utils.formatCurrency(newOpening)}.\n\nDifférence: ${Utils.formatCurrency(difference)}\n\nÊtes-vous sûr de vouloir continuer ?`)) {
            return;
          }
        }
        
        // Mettre à jour les soldes
        this.dataManager.data.cashRegister.openingBalance = newOpening;
        this.dataManager.data.cashRegister.closingBalance += difference;
        
        // Enregistrer l'opération
        const operation = {
          id: Utils.generateId('ADJ_'),
          date: new Date().toISOString(),
          type: difference >= 0 ? 'entree' : 'sortie',
          amount: Math.abs(difference),
          description: `Ajustement solde initial: ${reason} (Ancien: ${Utils.formatCurrency(oldOpening)}, Nouveau: ${Utils.formatCurrency(newOpening)})`,
          userId: this.currentUser.id,
          previousBalance: this.dataManager.data.cashRegister.closingBalance - difference,
          newBalance: this.dataManager.data.cashRegister.closingBalance
        };
        
        this.dataManager.data.cashOperations.push(operation);
        
        // Ajouter aux transactions
        this.dataManager.data.cashRegister.transactions.push({
          id: operation.id,
          date: operation.date,
          type: 'adjustment',
          amount: difference,
          description: `Ajustement solde initial: ${reason}`,
          userId: this.currentUser.id
        });
        
        this.dataManager.save();
        this.updateStats();
        
        // Réinitialiser le champ de raison
        document.getElementById('cashChangeReason').value = '';
        
        this.dataManager.showNotification(`Solde initial ajusté de ${Utils.formatCurrency(difference)}`, 'success');
        
        // Recharger la page pour afficher les nouvelles valeurs
        this.loadPage('cashconfig');
      }

      resetCashToOpening() {
        if (!confirm('Êtes-vous sûr de vouloir réinitialiser le solde actuel au solde initial ?\n\nToutes les opérations non enregistrées seront conservées mais le solde sera remis à zéro.')) {
          return;
        }
        
        const reason = prompt('Raison de la réinitialisation :');
        if (!reason) {
          this.dataManager.showNotification('Opération annulée', 'warning');
          return;
        }
        
        const oldBalance = this.dataManager.data.cashRegister.closingBalance;
        const openingBalance = this.dataManager.data.cashRegister.openingBalance;
        const difference = openingBalance - oldBalance;
        
        this.dataManager.data.cashRegister.closingBalance = openingBalance;
        
        // Enregistrer l'opération
        const operation = {
          id: Utils.generateId('RESET_'),
          date: new Date().toISOString(),
          type: difference >= 0 ? 'entree' : 'sortie',
          amount: Math.abs(difference),
          description: `Réinitialisation caisse: ${reason} (Ancien solde: ${Utils.formatCurrency(oldBalance)}, Réinitialisé à: ${Utils.formatCurrency(openingBalance)})`,
          userId: this.currentUser.id,
          previousBalance: oldBalance,
          newBalance: openingBalance
        };
        
        this.dataManager.data.cashOperations.push(operation);
        
        this.dataManager.data.cashRegister.transactions.push({
          id: operation.id,
          date: operation.date,
          type: 'reset',
          amount: difference,
          description: `Réinitialisation caisse: ${reason}`,
          userId: this.currentUser.id
        });
        
        this.dataManager.save();
        this.updateStats();
        
        this.dataManager.showNotification('Caisse réinitialisée au solde initial', 'success');
        this.loadPage('cashconfig');
      }

      closeCashRegister() {
        if (!confirm('Êtes-vous sûr de vouloir fermer la caisse ?\n\nCette action enregistrera le solde final et préparera la caisse pour le jour suivant.')) {
          return;
        }
        
        const realBalance = prompt('Entrez le solde physique réel en caisse :');
        if (!realBalance || isNaN(parseFloat(realBalance))) {
          this.dataManager.showNotification('Valeur invalide', 'danger');
          return;
        }
        
        const realBalanceNum = parseFloat(realBalance);
        const systemBalance = this.dataManager.data.cashRegister.closingBalance;
        const difference = realBalanceNum - systemBalance;
        
        // Enregistrer la fermeture
        this.dataManager.data.cashRegister.lastClosed = new Date().toISOString();
        
        // Créer un rapport de fermeture
        const closingReport = {
          id: Utils.generateId('CLOSE_'),
          date: new Date().toISOString(),
          expectedBalance: systemBalance,
          actualBalance: realBalanceNum,
          difference: difference,
          openingBalance: this.dataManager.data.cashRegister.openingBalance,
          transactionsCount: this.dataManager.data.cashRegister.transactions.length,
          closedBy: this.currentUser.id
        };
        
        // Ajouter à l'historique
        if (!this.dataManager.data.cashRegister.closingHistory) {
          this.dataManager.data.cashRegister.closingHistory = [];
        }
        this.dataManager.data.cashRegister.closingHistory.push(closingReport);
        
        // Réinitialiser pour le jour suivant (optionnel)
        if (confirm('Voulez-vous réinitialiser la caisse pour le jour suivant ?')) {
          this.dataManager.data.cashRegister.openingBalance = realBalanceNum;
          this.dataManager.data.cashRegister.closingBalance = realBalanceNum;
          this.dataManager.data.cashRegister.transactions = [];
        }
        
        this.dataManager.save();
        
        // Afficher le rapport
        const modal = document.getElementById('genericModal');
        modal.querySelector('#modalTitle').textContent = 'Rapport de fermeture de caisse';
        
        modal.querySelector('#modalBody').innerHTML = `
          <div class="alert ${difference === 0 ? 'alert-success' : Math.abs(difference) < 10000 ? 'alert-warning' : 'alert-danger'}">
            <h4><i class="fas fa-${difference === 0 ? 'check-circle' : 'exclamation-triangle'}"></i> 
            ${difference === 0 ? 'Caisse conforme' : 'Écart détecté'}</h4>
            <p><strong>Solde système :</strong> ${Utils.formatCurrency(systemBalance)}</p>
            <p><strong>Solde physique :</strong> ${Utils.formatCurrency(realBalanceNum)}</p>
            <p><strong>Écart :</strong> <span class="${difference === 0 ? 'text-success' : difference > 0 ? 'text-warning' : 'text-danger'}">
              ${Utils.formatCurrency(difference)} ${difference > 0 ? '(Trop perçu)' : difference < 0 ? '(Manquant)' : ''}
            </span></p>
          </div>
          <div class="form-group">
            <label class="form-label">Commentaires sur la fermeture</label>
            <textarea id="closingComments" class="form-control" rows="3" placeholder="Notes sur la fermeture..."></textarea>
          </div>
        `;
        
        modal.querySelector('#modalFooter').innerHTML = `
          <button class="btn btn-primary" id="modalConfirm">Enregistrer et imprimer</button>
        `;
        
        modal.classList.add('active');
        
        modal.querySelector('#modalConfirm').onclick = () => {
          const comments = document.getElementById('closingComments').value;
          closingReport.comments = comments;
          this.dataManager.save();
          
          this.dataManager.showNotification('Caisse fermée avec succès', 'success');
          this.closeModal();
          this.loadPage('cashconfig');
        };
      }


      closeModal() {
        document.getElementById('genericModal').classList.remove('active');
      }

      autoSave() {
        if (this.dataManager.data.settings.autoBackup) {
          this.dataManager.save();
        }
      }
    }

    // Initialiser l'application
    const app = new POSApplication();
    window.app = app;
    window.Utils = Utils;
  </script>
</body>
</html>